<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì¶œì„ ê¸°ë¡ ë“±ë¡ | ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .header { border-bottom: 3px solid #e67e22; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .upload-section { background: #fff5e6; padding: 20px; border-radius: 10px; border: 1.5px dashed #e67e22; text-align: center; margin-bottom: 30px; }
        .status-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-main { background: #e67e22; color: white; }
        .btn-nav { background: #34495e; color: white; text-decoration: none; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f8f9fa; }
        .highlight { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0; color:#e67e22;">ğŸ“… ì¼ì¼ ì¶œì„ ë°ì´í„° ë“±ë¡</h2>
        <a href="#" class="btn btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <div class="upload-section">
        <p style="margin-top:0;"><strong>[ì¼ì¼ ì¶œì„ë¶€ ì—‘ì…€ ì—…ë¡œë“œ]</strong></p>
        <input type="file" id="dailyExcel" accept=".xlsx, .xls" onchange="uploadDailyAttendance(this)">
        <p style="font-size: 12px; color: #666; margin-top: 10px;">â€» í•™ìƒë³„ ì…ì‹¤/í‡´ì‹¤ ì‹œê°„, ê³µê°€, ì§€ê° ê¸°ë¡ì´ ë‹´ê¸´ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <div class="status-box">
        <p><strong>í˜„ì¬ í•™ê¸‰:</strong> <span id="dispClass" class="highlight">-</span></p>
        <p><strong>ìµœê·¼ ë“±ë¡ëœ ì¼ì:</strong> <span id="lastDate" class="highlight">ì—†ìŒ</span></p>
        <div id="uploadLog" style="font-size: 12px; color: #555; max-height: 200px; overflow-y: auto;">
            ë“±ë¡ ëŒ€ê¸° ì¤‘...
        </div>
    </div>
</div>

<script>
// Firebase ì„¤ì • (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "701";
document.getElementById('dispClass').innerText = currentClass;

let masterSubjectList = [];

// [ì¶”ê°€] ì‹œì‘ ì‹œ êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ ë¯¸ë¦¬ ë¡œë“œ (íœ´ì¼ íŒë³„ìš©)
database.ref(`${currentClass}/masterData/courses`).once('value', snap => {
    const courses = snap.val() || [];
    masterSubjectList = [...new Set(courses.map(c => c.subject.trim()))];
});

/* [í•µì‹¬ ê¸°ëŠ¥] ì¼ì¼ ì¶œì„ ì—‘ì…€ ì—…ë¡œë“œ ë° DB ì €ì¥ */
function uploadDailyAttendance(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array', raw: false});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        if(json.length === 0) {
            alert("íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // íŒŒì¼ ë‚´ì— ìˆëŠ” 'ë‚ ì§œ'ë¥¼ í™•ì¸ (ì²« ë²ˆì§¸ í–‰ ê¸°ì¤€)
        let attendanceDate = json[0]['ë‚ ì§œ'] || json[0]['ì¼ì'];
        if(!attendanceDate) {
            attendanceDate = prompt("íŒŒì¼ì—ì„œ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ ì¶œì„ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2025-08-04)", "");
        }
        
        if(!attendanceDate) return;

        // ë‚ ì§œ í˜•ì‹ ì •ë¦¬ (YYYY-MM-DD)
        const formattedDate = attendanceDate.replace(/\./g, '-').substring(0, 10);

        // [ì •ë°€ ìˆ˜ë¦¬] ì—‘ì…€ í–‰ ë°ì´í„° ë¶„ì„ ë° ì €ì¥
        const dailyUpdate = {};
        json.forEach(row => {
            const name = row['í›ˆë ¨ìƒëª…'] || row['ì„±ëª…'];
            if(name) {
                // ì…ì‹¤/í‡´ì‹¤ ì‹œê°„ í™•ë³´
                let inT = row['ì…ì‹¤ì‹œê°„'] || row['ì…ì‹¤'] || "";
                let outT = row['í‡´ì‹¤ì‹œê°„'] || row['í‡´ì‹¤'] || "";
                let status = row['ì¶œê²°ìƒíƒœ'] || row['ìƒíƒœ'] || "ì •ìƒ";
                
                // [ì„ ìƒë‹˜ ë¡œì§ ì ìš©] ì—‘ì…€ì˜ êµê³¼ëª©ì´ ë§ˆìŠ¤í„° ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
                // ë§Œì•½ 'ëŒ€ì²´íœ´ì¼'ì²˜ëŸ¼ ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ë‹¨ì–´ë¼ë©´ ì¶œì„ ì‹œê°„ì„ 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë¹„ê³ ì— ê¸°ë¡ ê°€ëŠ¥
                const rowSubject = row['êµê³¼ëª©'] ? String(row['êµê³¼ëª©']).trim() : "";
                const isHoliday = rowSubject !== "" && !masterSubjectList.includes(rowSubject);

                dailyUpdate[name] = {
                    inTime: isHoliday ? "" : inT,
                    outTime: isHoliday ? "" : outT,
                    status: isHoliday ? rowSubject : status, // íœ´ì¼ì¸ ê²½ìš° ìƒíƒœì°½ì— íœ´ì¼ëª… í‘œì‹œ
                    note: row['ë¹„ê³ '] || (isHoliday ? "ê³µì‹ íœ´ì¼(ìˆ˜ì—… ì—†ìŒ)" : "")
                };
            }
        });

        database.ref(`${currentClass}/dailyAttendance/${formattedDate}`).set(dailyUpdate)
            .then(() => {
                // [ì—°ë™] ëŠ¥ë ¥ë‹¨ìœ„ì‹œê°„í‘œ í™”ë©´ì—ì„œë„ 'ì²´í¬' í‘œì‹œê°€ ëœ¨ë„ë¡ attendance ë‚ ì§œ ê¸°ë¡
                database.ref(`${currentClass}/attendance/${formattedDate}`).set(true);
                
                alert(`${formattedDate} ì¶œì„ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                document.getElementById('lastDate').innerText = formattedDate;
                logUpload(formattedDate, Object.keys(dailyUpdate).length);
            })
            .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
    };
    reader.readAsArrayBuffer(file);
}

function logUpload(date, count) {
    const log = document.getElementById('uploadLog');
    const entry = document.createElement('div');
    entry.style.borderBottom = "1px solid #eee";
    entry.style.padding = "5px 0";
    entry.innerText = `[${new Date().toLocaleTimeString()}] ${date} - ${count}ëª… ì™„ë£Œ`;
    log.prepend(entry);
}
</script>
</body>
</html>