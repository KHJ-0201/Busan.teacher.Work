<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í•™ìƒ ì‘ì‹œ - ìë™ì°¨ CBT</title>
    <link rel="stylesheet" href="B_style.css">
    <style>
        /* [ê¸°ì¡´ ë””ìì¸ ë° ëª¨ë°”ì¼ ìµœì í™” ì½”ë“œ ìœ ì§€ - ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€] */
        .exam-subject-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; padding: 10px; border-bottom: 3px double #000; color: #2c3e50; }
        .report-table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #000; margin-bottom: 20px; }
        .report-table td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 14px; height: 45px; word-break: keep-all; background-color: #ffffff; }
        .bg-blue-label { background-color: #e3f2fd !important; font-weight: bold; }
        .col-label-1 { width: 15%; } .col-content-1 { width: 45%; } .col-label-2 { width: 13.33%; } .col-content-2 { width: 26.67%; }
        .col-bottom-purpose { width: 60%; } .col-bottom-score { width: 13.33%; } .col-bottom-level { width: 13.33%; } .col-bottom-teacher { width: 13.34%; }
        
        #resScore, #resLevel { font-weight: bold; font-size: 20px; color: #e74c3c; } 
        .mark-o { color: blue; font-weight: bold; } .mark-x { color: red; font-weight: bold; }

        .question-table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #000; margin-top: 20px; }
        .q-header { background-color: #e3f2fd; font-weight: bold; border: 1px solid #000; padding: 10px; text-align: center; }
        .q-row td { border: 1px solid #000; padding: 15px; vertical-align: middle; background-color: #ffffff; }
        
        .col-q-no { width: 8%; font-weight: bold; text-align: center; font-size: 16px; }
        .col-q-main { width: 77%; text-align: left; }
        .col-q-ans { width: 7.5%; text-align: center; font-size: 16px; }
        .col-q-chk { width: 7.5%; text-align: center; font-size: 18px; font-weight: bold; color: red; } 
        
        .q-inner-flex { display: flex; gap: 20px; align-items: flex-start; }
        .q-img-box { flex: 0 0 250px; }
        .q-img-box img { width: 100%; border: 1px solid #ddd; border-radius: 4px; }
        .q-text-box { flex: 1; }
        .q-options-list { list-style: none; padding: 0; margin: 8px 0 0 0; }
        .q-options-list li { margin-bottom: 6px; display: flex; align-items: center; border: none; } 
        .q-options-list input[type="radio"] { display: none; }
        .q-opt-label { cursor: pointer; display: flex; align-items: center; font-size: 15px; border: none; line-height: 1.2; }
        .q-opt-label::before { content: ''; display: inline-block; width: 18px; height: 18px; border: 1.5px solid #333; margin-right: 8px; background: #fff; text-align: center; line-height: 16px; font-size: 12px; font-weight: bold; }
        input[type="radio"]:checked + .q-opt-label::before { content: 'âœ”'; background: #333; color: #fff; }
        
        #userName { width: 100px; border: none; border-bottom: 1px solid #ccc; font-size: 16px; font-weight: bold; background: #fffdf0; padding: 5px; text-align: center; }
        .name-sign-wrapper { display: flex; align-items: center; justify-content: center; position: relative; }
        .sign-stamp-box { position: relative; width: 80px; height: 50px; margin-left: 5px; display: flex; align-items: center; justify-content: center; }
        .sign-in-text { font-size: 16px; color: rgba(0,0,0,0.15); font-weight: bold; z-index: 1; border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; }
        .sign-stamp-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2; pointer-events: none; }

        @media screen and (max-width: 768px) {
            .report-table td { font-size: 10px !important; padding: 4px 1px !important; word-break: break-all !important; line-height: 1.1 !important; }
            .col-label-1 { width: 22% !important; } .col-content-1 { width: 38% !important; }
            .col-label-2 { width: 18% !important; } .col-content-2 { width: 22% !important; }
            #userName { width: 80px !important; font-size: 13px !important; }
            .sign-stamp-box { width: 50px !important; height: 35px !important; margin-left: 2px !important; }
            .sign-in-text { width: 25px !important; height: 25px !important; font-size: 12px !important; }
            .col-q-ans, .col-q-chk, [id^="ans_display_"], [id^="chk_display_"], .q-header:nth-child(3), .q-header:nth-child(4) { display: none !important; }
            .col-q-no { width: 12% !important; font-size: 11px !important; }
            .col-q-main { width: 88% !important; }
            .q-row td { padding: 8px 4px !important; }
            .q-inner-flex { flex-direction: column !important; gap: 6px !important; }
            .q-img-box { width: 100% !important; flex: none !important; text-align: center !important; }
            .q-img-box img { max-height: 160px !important; width: auto !important; max-width: 100% !important; }
            .q-options-list li { margin-bottom: 4px !important; }
            .q-opt-label { font-size: 13.5px !important; }
            #classSelectModal > div { width: 94% !important; padding: 20px 10px !important; }
        }
    </style>
     <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div id="classSelectModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; text-align:center; width:450px;">
            <h2 style="margin-bottom:15px; color:#2c3e50;">ğŸš— ë°˜ ì„ íƒ ë° ì„±ëª… ì…ë ¥</h2>
            <select id="studentClassSelect" style="padding:12px; font-size:18px; width:100%; margin-bottom:12px; border:2px solid #3498db; border-radius:8px;">
                <option value="">--- ë³¸ì¸ ë°˜ ì„ íƒ ---</option>
                <option value="501ë°˜">501ë°˜</option><option value="601ë°˜">601ë°˜</option><option value="602ë°˜">602ë°˜</option>
                <option value="603ë°˜">603ë°˜</option><option value="701ë°˜">701ë°˜</option><option value="702ë°˜">702ë°˜</option><option value="703ë°˜">703ë°˜</option>
            </select>
            <input type="text" id="startUserName" placeholder="ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="padding:12px; font-size:18px; width:100%; box-sizing:border-box; border:2px solid #3498db; border-radius:8px; margin-bottom:12px; text-align:center;">
            <div style="margin-top: 15px; border: 2px dashed #3498db; border-radius: 8px; padding: 10px; background: #f0f7ff;">
                <div style="font-size: 14px; color: #2c3e50; margin-bottom: 8px; font-weight: bold;">ì´ë¦„ì„ ì •ìë¡œ ì ì–´ì£¼ì„¸ìš”.</div>
                <canvas id="signPad" style="background: white; border: 1px solid #3498db; cursor: crosshair; touch-action: none; border-radius: 4px; width: 100%; display: block;"></canvas>
                <button onclick="clearSign()" style="font-size: 12px; margin-top: 8px; cursor: pointer; color: #e74c3c; background: white; border: 1px solid #e74c3c; padding: 4px 12px; border-radius: 4px; font-weight: bold;">ë‹¤ì‹œ ì“°ê¸°</button>
            </div>
            <button onclick="startExam()" style="padding:15px; width:100%; font-size:18px; background:#3498db; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:15px;">ì‹œí—˜ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="exam-container" style="display:none;" id="examMainArea">
        <div id="displaySubTitle" class="exam-subject-title">ëŠ¥ë ¥ë‹¨ìœ„ í‰ê°€</div>
        <table class="report-table">
            <colgroup><col class="col-label-1"><col class="col-content-1"><col class="col-label-2"><col class="col-content-2"></colgroup>
            <tr><td class="bg-blue-label">í›ˆë ¨ê³¼ì •</td><td id="infoGroupName" style="text-align:left;"></td><td class="bg-blue-label">í›ˆë ¨ê¸°ê°„</td><td id="infoGroupPeriod"></td></tr>
            <tr>
                <td class="bg-blue-label">í›ˆë ¨ìƒëª…</td>
                <td>
                    <div class="name-sign-wrapper">
                        <input type="text" id="userName" readonly>
                        <div class="sign-stamp-box">
                            <span class="sign-in-text">ì¸</span>
                            <img id="displaySignImg" class="sign-stamp-img" src="" alt="">
                        </div>
                    </div>
                </td>
                <td class="bg-blue-label">ì‹œí–‰ì¼ì</td><td id="infoExamDate"></td>
            </tr>
        </table>
        <table class="report-table" style="margin-top:-1px;">
            <colgroup><col class="col-bottom-purpose"><col class="col-bottom-score"><col class="col-bottom-level"><col class="col-bottom-teacher"></colgroup>
            <tr><td class="bg-blue-label">ì‚¬ì „í‰ê°€ ëª©ì </td><td class="bg-blue-label">ì·¨ë“ì ìˆ˜</td><td class="bg-blue-label">ì‚¬ì „ìˆ˜ì¤€</td><td class="bg-blue-label">ë‹´ë‹¹êµì‚¬</td></tr>
            <tr><td id="infoExamPurpose" style="text-align:left; vertical-align:top; height:90px; padding:10px;"></td><td id="resScore"></td><td id="resLevel"></td><td id="infoTeacherName" style="font-weight:bold;"></td></tr>
        </table>
        <table class="question-table">
            <thead>
                <tr><th class="q-header col-q-no">ë²ˆí˜¸</th><th class="q-header col-q-main">ë¬¸ì œ</th><th class="q-header col-q-ans">ë‹µì•ˆ</th><th class="q-header col-q-chk">ì±„ì </th></tr>
            </thead>
            <tbody id="questionContainer"></tbody>
        </table>
        <div class="submit-area" id="submitArea" style="text-align:center; margin-top:30px; padding-bottom:50px;">
            <button onclick="submitExam()" style="padding:15px 40px; background:#3498db; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:18px;">ìµœì¢… ë‹µì•ˆ ì œì¶œ</button>
        </div>
    </div>

    <script>
        let examQuestions = [];
        let currentSubId = ""; 
        let isDrawing = false;
        let signCanvas, signCtx;

        window.onload = function() {
            signCanvas = document.getElementById('signPad');
            signCtx = signCanvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            signCtx.strokeStyle = "#000"; signCtx.lineWidth = 4; signCtx.lineJoin = "round"; signCtx.lineCap = "round";
            signCanvas.addEventListener('mousedown', startDrawing);
            signCanvas.addEventListener('mousemove', draw);
            signCanvas.addEventListener('mouseup', stopDrawing);
            signCanvas.addEventListener('mouseleave', stopDrawing);
            signCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            signCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            signCanvas.addEventListener('touchend', stopDrawing);
        };

        function resizeCanvas() {
            const container = signCanvas.parentElement;
            if(container) {
                signCanvas.width = container.clientWidth;
                signCanvas.height = 180;
                signCtx.strokeStyle = "#000"; signCtx.lineWidth = 4; signCtx.lineJoin = "round"; signCtx.lineCap = "round";
            }
        }

        function startDrawing(e) { isDrawing = true; draw(e); }
        function draw(e) {
            if (!isDrawing) return;
            const rect = signCanvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            signCtx.lineTo(x, y); signCtx.stroke(); signCtx.beginPath(); signCtx.moveTo(x, y);
        }
        function stopDrawing() { isDrawing = false; signCtx.beginPath(); }
        function clearSign() { signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height); }

        function startExam() {
            const selected = document.getElementById('studentClassSelect').value;
            const sName = document.getElementById('startUserName').value.trim();
            if(!selected || !sName) { alert("ë°˜ ì„ íƒê³¼ ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
            if(isSignCanvasEmpty()) { alert("ì´ë¦„ì„ ì •ìë¡œ ì„œëª…í•´ ì£¼ì„¸ìš”."); return; }

            const signDataUrl = signCanvas.toDataURL();
            sessionStorage.setItem('selectedClass', selected);
            
            const raw = localStorage.getItem(`${selected}_fullConfig`);
            if(raw) {
                const config = JSON.parse(raw);
                let targetId = "";
                [...(config.ncs || []), ...(config.nonNcs || [])].forEach(main => {
                    main.subSubjects.forEach(sub => { 
                        if(sub.isActive) {
                            // [ìˆ˜ì„ ] ê³µë°± ì œê±° ID ìƒì„±
                            targetId = (sub.name + sub.date).replace(/\s+/g, ''); 
                        }
                    });
                });
                
                if(targetId) {
                    const results = JSON.parse(localStorage.getItem(`${selected}_results_${targetId}`) || '[]');
                    const myResult = results.find(r => r.userName === sName);
                    
                    if(myResult) {
                        alert(`${sName} í•™ìƒì€ ì´ë¯¸ ì‘ì‹œí–ˆìŠµë‹ˆë‹¤. ì±„ì  ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                        document.getElementById('classSelectModal').style.display = 'none';
                        document.getElementById('examMainArea').style.display = 'block';
                        document.getElementById('userName').value = sName;
                        if(myResult.signData) document.getElementById('displaySignImg').src = myResult.signData;
                        loadActiveQuestions(selected, myResult); 
                        return;
                    }
                }
            }

            document.getElementById('displaySignImg').src = signDataUrl;
            document.getElementById('classSelectModal').style.display = 'none';
            document.getElementById('examMainArea').style.display = 'block';
            document.getElementById('userName').value = sName;
            loadActiveQuestions(selected);
        }

        function isSignCanvasEmpty() {
            const blank = document.createElement('canvas');
            blank.width = signCanvas.width; blank.height = signCanvas.height;
            return signCanvas.toDataURL() === blank.toDataURL();
        }

        function loadActiveQuestions(className, existingData = null) {
            const raw = localStorage.getItem(`${className}_fullConfig`);
            if(!raw) return;
            const config = JSON.parse(raw);
            examQuestions = [];
            [...(config.ncs || []), ...(config.nonNcs || [])].forEach(main => {
                main.subSubjects.forEach(sub => {
                    if(sub.isActive) {
                        sub.questions.forEach(q => examQuestions.push({...q}));
                        document.getElementById('infoGroupName').innerText = localStorage.getItem(`${className}_groupName`) || '';
                        document.getElementById('infoGroupPeriod').innerText = localStorage.getItem(`${className}_groupPeriod`) || '';
                        document.getElementById('infoTeacherName').innerText = localStorage.getItem(`${className}_teacherName`) || '';
                        document.getElementById('infoExamPurpose').innerText = sub.purpose || "";
                        document.getElementById('infoExamDate').innerText = sub.date || "";
                        document.getElementById('displaySubTitle').innerText = `(${main.title}) ${sub.name}`;
                        
                        // [í•µì‹¬ ë°°ì„ ] C_scriptì™€ ë™ì¼í•˜ê²Œ ê³µë°±ì„ ì œê±°í•˜ì—¬ IDë¥¼ ê³ ì •í•©ë‹ˆë‹¤.
                        currentSubId = (sub.name + sub.date).replace(/\s+/g, '');
                    }
                });
            });
            renderQuestions(existingData);
        }

        function renderQuestions(existingData = null) {
            const container = document.getElementById('questionContainer');
            container.innerHTML = examQuestions.map((q, idx) => `
                <tr class="q-row">
                    <td class="col-q-no" id="q_no_${idx}">ë¬¸ì œ${idx+1}</td>
                    <td class="col-q-main">
                        <div class="q-inner-flex">
                            ${q.img ? `<div class="q-img-box"><img src="${q.img}"></div>` : ''}
                            <div class="q-text-box">
                                <div style="font-weight:bold; font-size:16px; margin-bottom:8px;">${q.text}</div>
                                <ul class="q-options-list">
                                    ${q.options.map((opt, oIdx) => `
                                        <li><input type="radio" id="q_${idx}_${oIdx}" name="q_${idx}" value="${oIdx+1}" onchange="updateAnswerDisplay(${idx}, ${oIdx+1})">
                                            <label for="q_${idx}_${oIdx}" class="q-opt-label">${oIdx+1}. ${opt}</label></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </td>
                    <td class="col-q-ans" id="ans_display_${idx}"></td>
                    <td class="col-q-chk" id="chk_display_${idx}"></td>
                </tr>`).join('');
            
            if(existingData) {
                existingData.details.forEach((d, idx) => {
                    const isCorrect = d.studentVal == d.correctAns;
                    const noEl = document.getElementById(`q_no_${idx}`);
                    if(noEl) noEl.innerHTML = `ë¬¸ì œ${idx+1}<br><span class="${isCorrect?'mark-o':'mark-x'}">(${isCorrect?'O':'X'})</span>`;
                    document.getElementById(`ans_display_${idx}`).innerText = d.studentVal;
                    document.getElementById(`chk_display_${idx}`).innerText = d.correctAns;
                    document.querySelectorAll(`input[name="q_${idx}"]`).forEach(r => {
                        if(r.value == d.studentVal) r.checked = true;
                        r.disabled = true;
                    });
                });
                document.getElementById('resScore').innerText = existingData.score + "ì ";
                document.getElementById('resLevel').innerText = existingData.level;
                document.getElementById('submitArea').style.display = 'none';
            }
        }

        function updateAnswerDisplay(qIdx, val) { 
            const el = document.getElementById(`ans_display_${qIdx}`);
            if(el) el.innerText = val; 
        }

        function submitExam() {
            const name = document.getElementById('userName').value.trim();
            const className = sessionStorage.getItem('selectedClass');
            const signData = document.getElementById('displaySignImg').src;
            if(!name) { alert("ì„±ëª…ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."); return; }
            if(!confirm("ìµœì¢… ë‹µì•ˆì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            let scoreCount = 0;
            const studentDetails = []; 
            
            examQuestions.forEach((q, idx) => {
                const sel = document.querySelector(`input[name="q_${idx}"]:checked`);
                const studentVal = sel ? sel.value : "0";
                const isCorrect = studentVal == q.answer;
                studentDetails.push({ studentVal: studentVal, correctAns: q.answer });
                
                const noEl = document.getElementById(`q_no_${idx}`);
                if (isCorrect) { 
                    if(noEl) noEl.innerHTML = `ë¬¸ì œ${idx+1}<br><span class="mark-o">(O)</span>`; 
                    scoreCount++; 
                } else { 
                    if(noEl) noEl.innerHTML = `ë¬¸ì œ${idx+1}<br><span class="mark-x">(X)</span>`; 
                }
                document.getElementById(`ans_display_${idx}`).innerText = studentVal;
                document.getElementById(`chk_display_${idx}`).innerText = q.answer;
                document.querySelectorAll(`input[name="q_${idx}"]`).forEach(i => i.disabled = true);
            });

            const finalScore = Math.round((scoreCount / examQuestions.length) * 100);
            let level = finalScore >= 80 ? "ìƒ" : (finalScore >= 60 ? "ì¤‘" : "í•˜");
            
            document.getElementById('resScore').innerText = finalScore + "ì ";
            document.getElementById('resLevel').innerText = level;

            const fullResultData = {
                userName: name, 
                score: finalScore, 
                level: level, 
                submitTime: new Date().toLocaleString(),
                displayTitle: document.getElementById('displaySubTitle').innerText,
                groupName: document.getElementById('infoGroupName').innerText,
                groupPeriod: document.getElementById('infoGroupPeriod').innerText,
                examDate: document.getElementById('infoExamDate').innerText,
                purpose: document.getElementById('infoExamPurpose').innerText,
                teacherName: document.getElementById('infoTeacherName').innerText,
                details: studentDetails,
                signData: signData
            };

            // [ì €ì¥ ë°°ì„  ì™„ì„±] C_scriptê°€ ì°¾ëŠ” ê³µë°± ì œê±°ëœ ID ì´ë¦„í‘œë¥¼ ë¶™ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
            const results = JSON.parse(localStorage.getItem(`${className}_results_${currentSubId}`) || '[]');
            results.push(fullResultData);
            localStorage.setItem(`${className}_results_${currentSubId}`, JSON.stringify(results));
            
            document.getElementById('submitArea').style.display = 'none';
            alert(`ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ì ìˆ˜: ${finalScore}ì `);
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>