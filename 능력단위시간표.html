<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ë¶€ | ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* [DESIGN_FIXED] ì„ ìƒë‹˜ì´ ìš”ì²­í•˜ì‹  ì—‘ì…€ ì‹œì•ˆì„± ìœ ì§€ */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .excel-container { max-width: 100%; background: white; padding: 30px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .excel-header-title { text-align: center; font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; }
        .excel-info-table { width: 100%; border: 2px solid #27ae60; background: #fff; margin-bottom: 20px; border-collapse: collapse; }
        .excel-info-table td { border: 1px solid #ccc; padding: 10px; font-size: 13px; }
        .info-label { background: #f0faf3; font-weight: bold; width: 120px; text-align: center; }
        .info-value { color: #27ae60; font-weight: bold; }
        .scroll-box { max-height: 700px; overflow: auto; border: 1px solid #ccc; position: relative; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        .attendance-table th { background: #f2f2f2; border: 1px solid #999; padding: 5px; position: sticky; top: 0; z-index: 40; }
        .sub-header { top: 31px !important; z-index: 35 !important; background: #fafafa !important; }
        .sticky-col { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 50; border-right: 2px solid #27ae60 !important; font-weight: bold; text-align: center; }
        .attendance-table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .total-section { background: #fff9f0 !important; font-weight: bold; border-left: 2px solid #e67e22 !important; }
        .btn-nav { padding: 8px 15px; background: white; border: 1.5px solid #3498db; border-radius: 4px; cursor: pointer; text-decoration: none; color: #3498db; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

<div class="excel-container">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <a href="#" class="btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ êµê³¼ëª© ì„¤ì •(ë©”ì¸)ìœ¼ë¡œ</a>
        <div style="font-weight:bold; color:#27ae60;">[ í•™ê¸‰: <span id="dispClass">-</span> ]</div>
    </div>

    <div class="excel-header-title">ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ë¶€</div>

    <table class="excel-info-table">
        <tr>
            <td class="info-label">â‘  í›ˆë ¨ê³¼ì • :</td><td class="info-value" id="infoCourse">-</td>
            <td class="info-label">â‘¡ í›ˆë ¨ê¸°ê°„ :</td><td class="info-value" id="infoPeriod">-</td>
        </tr>
        <tr>
            <td class="info-label">â‘¢ êµê³¼ëª©ëª… :</td>
            <td class="info-value">
                <select id="subjectSelect" onchange="filterTimetable(this.value)" style="width:100%; padding:5px; font-weight:bold; border:1px solid #27ae60;">
                    <option value="">êµê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </td>
            <td class="info-label">â‘£ ë‹´ë‹¹êµì‚¬ :</td><td class="info-value" id="infoTeacher">-</td>
        </tr>
    </table>

    <div style="background:#f0f7ff; padding:15px; border-radius:5px; border:1px solid #3498db; margin-bottom:20px;">
        <strong>ğŸ“‚ ì‹œê°„í‘œ(í–‰ìˆ˜ì •.xlsx) ì—…ë¡œë“œ: </strong>
        <input type="file" id="timetableFile" accept=".xlsx, .xls" onchange="processFile(this)">
        <p style="margin-top:5px; font-size:11px; color:#666;">â€» ë©”ì¸ ì„¤ì •ì—ì„œ í™•ì •ëœ êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡ìŒ(íœ´ì¼ ë“±)ì„ í•„í„°ë§í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="scroll-box">
        <table class="attendance-table">
            <thead id="sheetHead"></thead>
            <tbody id="sheetBody">
                <tr><td colspan="10" style="padding:100px; color:#999; text-align:center;">êµê³¼ëª©ì„ ì„ íƒí•˜ê³  ì‹œê°„í‘œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "701";
document.getElementById('dispClass').innerText = currentClass;

let masterSubjectList = []; // index.htmlì—ì„œ í—ˆê°€í•œ êµê³¼ëª© ë¦¬ìŠ¤íŠ¸
let rawTimetable = [];
let studentNames = ["ê°•ë¯¼ì„±", "ê¹€ë‚¨í›ˆ", "ê¹€ë¯¼ê·¼", "ë°•ì¢…í˜„", "ì•ˆì œë•", "ì–‘ì‹ ìš°", "ì—„íƒœí™˜", "ìš°ì •ë¯¼", "ìœ ê²½ê³¤", "ìœ ì§€í›ˆ", "ì´ì˜ì¤€", "ì´ì§„ëª…", "ì´íƒœê²½", "ì´íƒœê¶Œ", "ì´í˜¸ì˜", "ì „ë²•ë³´", "ì „íƒœë¯¼", "ì •ë¯¼ê·œ", "ì¡°ìœ¤ê¸°", "í•œë„ì›"];
/* [ìˆ˜ì •] í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ì—ì„œ ë°•ì œëœ ì‹œê°„í‘œ ìë™ ë™ê¸°í™” */
document.addEventListener('DOMContentLoaded', () => {
    // ì„œë²„ì—ì„œ ì‹œê°„í‘œ ì›ë³¸ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    database.ref(`${currentClass}/fullTimetable`).once('value', snap => {
        const data = snap.val();
        if(data) {
            rawTimetable = data; // ì„œë²„ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            console.log("âœ… ì„œë²„ ì‹œê°„í‘œ ë™ê¸°í™” ì™„ë£Œ");
        } else {
            console.log("âŒ ì €ì¥ëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    });
});
/* [í•„í„° ì—°ë™] index.htmlì˜ í™•ì • ë°ì´í„° ë¡œë“œ */
function loadMasterConfig() {
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('infoCourse').innerText = d.name || "-";
        document.getElementById('infoPeriod').innerText = d.period || "-";
        document.getElementById('infoTeacher').innerText = d.teacher || "-";
        
        // index.htmlì—ì„œ ì €ì¥í•œ êµê³¼ëª©ë“¤ë§Œ ì¶”ì¶œ (í•„í„° ì—­í• )
        if(d.courses) {
            masterSubjectList = [...new Set(d.courses.map(c => c.subject))];
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">ë¶„ì„í•  êµê³¼ëª© ì„ íƒ</option>';
            masterSubjectList.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub; opt.innerText = sub;
                select.appendChild(opt);
            });
        }
    });
}
loadMasterConfig();

/* [ìˆ˜ì •] ë°ì´í„° ìŠ¤ìº”: ë‚ ì§œ ì‹œì°¨ ì˜¤ë¥˜ë¥¼ ì¡ê¸° ìœ„í•´ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ë„ë¡ ì„¤ì • */
function processFile(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        // cellDates: false (ê¸°ë³¸ê°’)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—‘ì…€ì´ ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ë©‹ëŒ€ë¡œ ë°”ê¾¸ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        // raw: false ì„¤ì •ì„ í†µí•´ ì—‘ì…€ ì…€ì— ë³´ì´ëŠ” 'í…ìŠ¤íŠ¸' ê·¸ëŒ€ë¡œë¥¼ ê°•ì œë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        rawTimetable = XLSX.utils.sheet_to_json(sheet, { raw: false });
        alert("ì‹œê°„í‘œ ë¶„ì„ ì™„ë£Œ! êµê³¼ëª©ì„ ì„ íƒí•˜ë©´ í•„í„°ë§ëœ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.");
    };
    reader.readAsArrayBuffer(file);
}

/* [ìµœì¢… êµì •] ë‚ ì§œë¥¼ ê³„ì‚°í•˜ì§€ ì•Šê³  í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ìª¼ê°œì„œ ë…„-ì›”-ì¼ë¡œ ì¡°ë¦½í•˜ëŠ” ë°©ì‹ */
function filterTimetable(selectedSub) {
    if(!selectedSub || rawTimetable.length === 0) {
        alert("ì‹œê°„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ì—ì„œ ë¨¼ì € ë“±ë¡í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
        return;
    }

    const filteredRows = rawTimetable.filter(r => r['êµê³¼ëª©'] === selectedSub);
    const dateMap = {};

    filteredRows.forEach(row => {
        let dateKey = "ë‚ ì§œë¯¸ìƒ";
        
        if (row['ë‚ ì§œ']) {
            // ì—‘ì…€ì—ì„œ ê°€ì ¸ì˜¨ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (ê³„ì‚° ì ˆëŒ€ ê¸ˆì§€)
            let s = String(row['ë‚ ì§œ']).trim();
            
            // 1. ì›”/ì¼/ë…„(ë¯¸êµ­ì‹) í˜¹ì€ ì¼/ì›”/ë…„ í˜•ì‹ì¼ ê²½ìš° ëŒ€ë¹„
            if (s.includes('/')) {
                let parts = s.split('/');
                if (parts.length === 3) {
                    let mm = parts[0].padStart(2, '0');
                    let dd = parts[1].padStart(2, '0');
                    let yy = parts[2];
                    if (yy.length === 2) yy = "20" + yy; // 25 -> 2025 ë³´ì •
                    // ë¯¸êµ­ì‹(MM/DD/YYYY)ì´ë¼ê³  ê°€ì •í•˜ê³  YYYY-MM-DDë¡œ ì¬ì¡°ë¦½
                    dateKey = `${yy}-${mm}-${dd}`;
                }
            } 
            // 2. ë…„.ì›”.ì¼ í˜•ì‹ì¸ ê²½ìš°
            else if (s.includes('.')) {
                dateKey = s.replace(/\./g, '-').substring(0, 10);
            }
            // 3. ì´ë¯¸ ë…„-ì›”-ì¼ í˜•ì‹ì¸ ê²½ìš°
            else if (s.includes('-')) {
                // ì‹œì°¨ ê³„ì‚°ìœ¼ë¡œ ì¸í•´ T15:00:00Z ë“±ì´ ë¶™ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì• 10ìë§Œ ìë¦„
                dateKey = s.substring(0, 10);
            }
            else {
                dateKey = s;
            }
        }
        
        if(!dateMap[dateKey]) dateMap[dateKey] = { am: 0, pm: 0 };
        
        const period = String(row['êµì‹œ']).trim();
        if(['1','2','3','4'].includes(period)) {
            dateMap[dateKey].am += 60;
        } else if(['5','6','7','8'].includes(period)) {
            dateMap[dateKey].pm += 60;
        }
    });

    // ë‚ ì§œë³„ë¡œ ì •ë ¬ (YYYY-MM-DD í˜•ì‹ì´ë¼ ë¬¸ìì—´ ì •ë ¬ë§Œìœ¼ë¡œë„ ìˆœì„œê°€ ë§ìŠµë‹ˆë‹¤)
    const targetDates = Object.keys(dateMap).sort();
    renderExcelSheet(targetDates, dateMap);
}

function renderExcelSheet(dates, info) {
    const thead = document.getElementById('sheetHead');
    const tbody = document.getElementById('sheetBody');

    // í—¤ë” (ë‚ ì§œ + ì˜¤ì „/ì˜¤í›„ 2ë‹¨ êµ¬ì¡°)
    let h1 = `<tr><th rowspan="2" class="sticky-col">í›ˆë ¨ìƒëª…</th>`;
    let h2 = `<tr>`;
    dates.forEach(d => {
        h1 += `<th colspan="2">${d}</th>`;
        h2 += `<th class="sub-header">ì˜¤ì „</th><th class="sub-header">ì˜¤í›„</th>`;
    });
    h1 += `<th colspan="2" class="total-section">ëˆ„ê³„</th><th rowspan="2" class="total-section">ì´ìˆ˜ì—¬ë¶€</th></tr>`;
    h2 += `<th class="sub-header total-section">ë¶„</th><th class="sub-header total-section">ì‹œê°„</th></tr>`;
    thead.innerHTML = h1 + h2;

    tbody.innerHTML = '';
    studentNames.forEach(name => {
        let rowHtml = `<td class="sticky-col">${name}</td>`;
        let totalMin = 0;
        dates.forEach(d => {
            const am = info[d].am || 0;
            const pm = info[d].pm || 0;
            rowHtml += `<td>${am || ""}</td><td>${pm || ""}</td>`;
            totalMin += (am + pm);
        });
        rowHtml += `<td class="total-section">${totalMin}</td><td class="total-section">${(totalMin/60).toFixed(1)}h</td><td class="total-section">ì´ìˆ˜</td>`;
        const tr = document.createElement('tr');
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
    });
}
</script>
</body>
</html>