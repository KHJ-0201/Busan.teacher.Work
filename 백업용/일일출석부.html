<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì¶œì„ ê¸°ë¡ ë“±ë¡ | ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .header { border-bottom: 3px solid #e67e22; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .info-bar { background: #fff5e6; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e67e22; }
        .date-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .date-list-table th, .date-list-table td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .date-list-table th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .status-none { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .status-done { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-upload { background: #e67e22; color: white; }
        .btn-nav { background: #34495e; color: white; text-decoration: none; display: inline-block; }
        .btn-danger { background: #c0392b; color: white; margin-left: 10px; }
        #hiddenFileInput { display: none; }
        .scroll-area { max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        .highlight { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0; color:#e67e22;">ğŸ“… ì¼ì¼ ì¶œì„ ë°ì´í„° ê´€ë¦¬ (í›ˆë ¨ì¼ìë³„)</h2>
        <div>
            <button class="btn btn-danger" onclick="clearAllAttendance()">ğŸ§¹ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
            <a href="#" class="btn btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ ë©”ì¸ìœ¼ë¡œ</a>
        </div>
    </div>

    <div class="info-bar">
        <div><strong>í•™ê¸‰:</strong> <span id="dispClass" class="highlight">-</span></div>
        <div id="courseInfo" style="font-size: 14px; color: #666;">í›ˆë ¨ ê¸°ê°„ ë¡œë”© ì¤‘...</div>
        <div><strong>ì´ í›ˆë ¨ì¼ìˆ˜:</strong> <span id="totalWorkDays" class="highlight">0</span>ì¼</div>
    </div>

    <div class="section-card">
        <p style="margin-bottom: 10px; font-size: 14px; color: #555;">
            â€» ê³µê°€, íœ´ê°€, ê²½ì¡°ì‚¬ ë“±ì€ ì…/í‡´ì‹¤ ì‹œê°„ì´ ì—†ì–´ë„ <strong>ìë™ìœ¼ë¡œ í’€íƒ€ì„ ì¶œì„ ì²˜ë¦¬</strong>ë©ë‹ˆë‹¤.
        </p>
        <div class="scroll-area">
            <table class="date-list-table">
                <thead>
                    <tr>
                        <th width="15%">í›ˆë ¨ì¼ìˆ˜</th>
                        <th width="20%">ë‚ ì§œ(ìš”ì¼)</th>
                        <th width="40%">ì§„í–‰ êµê³¼ëª©</th>
                        <th width="10%">ìƒíƒœ</th>
                        <th width="15%">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="dateListBody">
                    <tr><td colspan="5" style="padding:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<input type="file" id="hiddenFileInput" accept=".xlsx, .xls" onchange="handleFileSelect(this)">

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "í…ŒìŠ¤íŠ¸";
document.getElementById('dispClass').innerText = currentClass;

let rawTimetable = [];
let uploadedDates = {};
let selectedTargetDate = "";

function formatExcelTime(val) {
    if (!val || val === "-" || val === "") return "00:00:00";
    if (typeof val === 'number') {
        let totalSeconds = Math.round(val * 86400);
        let h = Math.floor(totalSeconds / 3600);
        let m = Math.floor((totalSeconds % 3600) / 60);
        let s = totalSeconds % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    return String(val).trim();
}
// 1. [ë‚ ì§œ ì •ë°€ êµì •] ì–´ë–¤ í˜•ì‹ì´ ë“¤ì–´ì™€ë„ YYYY-MM-DDë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
function getFixDate(rawDate) {
    if (!rawDate) return "";
    let s = String(rawDate).trim();
    
    // 2025.08.13 -> 2025-08-13 (ë§ˆì¹¨í‘œ ì œê±°)
    s = s.replace(/\./g, '-');
    
    // 08/13/25 (ì—‘ì…€ ë‚ ì§œ í˜•ì‹) ì²˜ë¦¬
    if (s.includes('/')) {
        let parts = s.split('/');
        if (parts.length === 3) {
            // ì—°ë„ê°€ 2ê¸€ì(25)ë©´ 20ì„ ë¶™ì—¬ 4ê¸€ì(2025)ë¡œ ë§Œë“¬
            let year = parts[2].length === 2 ? "20" + parts[2] : parts[2];
            let month = parts[0].padStart(2, '0');
            let day = parts[1].padStart(2, '0');
            s = `${year}-${month}-${day}`;
        }
    }
    
    // ìµœì¢…ì ìœ¼ë¡œ 10ê¸€ì(YYYY-MM-DD)ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    return s.substring(0, 10);
}

// 2. [ì´ˆê¸°í™” ë¡œì§] ì‹¤ì‹œê°„ ìˆ˜ì‹ ê¸°ë¥¼ ì•ˆì •í™”í•©ë‹ˆë‹¤.
function initialize() {
    // ê³¼ì • ì •ë³´ ë¡œë“œ
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('courseInfo').innerText = `${d.name || ""} (${d.period || ""})`;
    });

    // ì—…ë¡œë“œëœ ë‚ ì§œ ëª©ë¡ ì‹¤ì‹œê°„ ê°ì‹œ (í‘œì¤€í™”ëœ ë‚ ì§œë¡œ ê°€ì ¸ì˜´)
    database.ref(`${currentClass}/dailyAttendance`).on('value', snap => {
        uploadedDates = snap.val() || {};
        renderDateList();
    });

    // ì „ì²´ ì‹œê°„í‘œ ë¡œë“œ (í‘œì¤€í™”ëœ ë‚ ì§œë¡œ ëª©ë¡ ìƒì„±)
    database.ref(`${currentClass}/fullTimetable`).once('value', snap => {
        rawTimetable = snap.val() || [];
        renderDateList();
    });
}

// 3. [ëª©ë¡ ì¶œë ¥] í‘œì¤€í™”ëœ ë‚ ì§œ ê·œê²©ìœ¼ë¡œ í‘œë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
function renderDateList() {
    const tbody = document.getElementById('dateListBody');
    if (rawTimetable.length === 0) return;

    const dayMap = {};
    rawTimetable.forEach(row => {
        // [í•µì‹¬] ì‹œê°„í‘œì˜ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¬ ë•Œ ë¬´ì¡°ê±´ getFixDateë¡œ ì„¸ì²™í•©ë‹ˆë‹¤.
        const d = getFixDate(row.ë‚ ì§œ);
        if(!d) return;

        if(!dayMap[d]) {
            dayMap[d] = { 
                date: d, 
                dayNum: row.ì¼ìˆ˜ || "-", 
                weekday: row.ìš”ì¼ || "", 
                subjects: new Set() 
            };
        }
        if(row.êµê³¼ëª© && row.êµì‹œ !== "ì ì‹¬") {
            dayMap[d].subjects.add(row.êµê³¼ëª©);
        }
    });

    const sortedDates = Object.keys(dayMap).sort();
    document.getElementById('totalWorkDays').innerText = sortedDates.length;

    tbody.innerHTML = sortedDates.map(dKey => {
        const info = dayMap[dKey];
        // [í•µì‹¬] ì—…ë¡œë“œëœ ë°ì´í„° ì—­ì‹œ dKey(YYYY-MM-DD) í˜•ì‹ìœ¼ë¡œ ëŒ€ì¡°í•©ë‹ˆë‹¤.
        const isDone = uploadedDates[dKey] ? true : false;
        
        return `
            <tr>
                <td>${info.dayNum}íšŒì°¨</td>
                <td><strong>${info.date}</strong> (${info.weekday})</td>
                <td style="text-align:left; font-size:12px;">${Array.from(info.subjects).join(', ')}</td>
                <td><span class="status-badge ${isDone ? 'status-done' : 'status-none'}">${isDone ? 'âœ” ë“±ë¡ì™„ë£Œ' : 'ë¯¸ë“±ë¡'}</span></td>
                <td><button class="btn btn-upload" onclick="triggerUpload('${info.date}')">${isDone ? 'ì¬ì—…ë¡œë“œ' : 'íŒŒì¼ì°¾ê¸°'}</button></td>
            </tr>`;
    }).join('');
}

function triggerUpload(date) {
    selectedTargetDate = date;
    document.getElementById('hiddenFileInput').click();
}

// [ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥]
function clearAllAttendance() {
    if(confirm("â— ì£¼ì˜: í˜„ì¬ í•™ê¸‰ì˜ ëª¨ë“  ì¼ì¼ ì¶œì„ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        database.ref(`${currentClass}/dailyAttendance`).remove()
            .then(() => alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì—‘ì…€ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”."))
            .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err));
    }
}

// [ìˆ˜ë¦¬ í•µì‹¬] ì—‘ì…€ ë°ì´í„° ì¶”ì¶œ ë¡œì§ (ì™¸ì¶œ/ë³µê·€ ë°°ì„  ì—°ê²°)
function handleFileSelect(input) {
    const file = input.files[0];
    if(!file || !selectedTargetDate) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

        if(rows.length < 3) {
            alert("íŒŒì¼ ì–‘ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const dailyUpdate = {};
        
        for(let i = 2; i < rows.length; i++) {
    const row = rows[i];
    if (!row || row.length < 2) continue;

    const name = row[1] ? String(row[1]).trim() : ""; 
    if(!name || name === "ì„±ëª…") continue;

    let status = row[6] ? String(row[6]).trim() : "-"; 
    let inTime = formatExcelTime(row[7]);  
    let outTime = formatExcelTime(row[8]); 
    let leaveTime = formatExcelTime(row[9]);
    let returnTime = formatExcelTime(row[10]);

    // íŠ¹ìˆ˜ ì¶œê²°(ê³µê°€ ë“±) ì‹œ 09:00~17:30 ê°•ì œ ì£¼ì…
    const specialAttendance = ["ê³µê°€", "íœ´ê°€", "ê²½ì¡°ì‚¬", "í›ˆë ¨ìˆ˜ë‹¹", "ê¸°íƒ€", "ì¶œì„ì¸ì •"];
    const isSpecial = specialAttendance.some(keyword => status.includes(keyword));

    if (isSpecial) {
        inTime = "09:00:00"; outTime = "17:30:00";
        leaveTime = ""; returnTime = "";
    } else if (status === "-" || status.includes("ê²°ì„") || inTime === "-" || inTime === "") {
        inTime = "00:00:00"; outTime = "00:00:00";
        leaveTime = ""; returnTime = "";
        if(status === "-") status = "ê²°ì„";
    }

    // [í‘œì¤€ ê·œê²© ì†¡ì‹ ]
    dailyUpdate[name] = {
        inTime, outTime, leaveTime, returnTime, status,
        note: row[14] || "" 
    };
}

        if(confirm(`[${selectedTargetDate}] ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            database.ref(`${currentClass}/dailyAttendance/${selectedTargetDate}`).set(dailyUpdate)
                .then(() => {
                    alert(`âœ… [${selectedTargetDate}] ì €ì¥ ì™„ë£Œ!`);
                    input.value = "";
                })
                .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
        }
    };
    reader.readAsArrayBuffer(file);
}

initialize();
</script>
</body>
</html>