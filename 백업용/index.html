<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë¹„ ê´€ë¦¬ | ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* [DESIGN_FIXED] ë””ìì¸ ì ˆëŒ€ ê³ ì • ë° ê²½ê³„ì„  ê°•í™” */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1750px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 20px; }
        .class-info-bar { background: #e3f2fd; padding: 12px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .btn-home { padding: 6px 12px; cursor: pointer; border: 1px solid #3498db; border-radius: 6px; background: white; color: #3498db; font-weight: bold; text-decoration: none; font-size: 13px; }
        .current-badge { background: #2c3e50; color: white; padding: 4px 12px; border-radius: 15px; font-size: 13px; font-weight: bold; }
        .section-card { background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #e1e4e8; margin-bottom: 20px; }
        
        .top-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; gap: 15px; margin-top: 10px; }
        .info-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .info-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 13px; }
        #trainingPeriod { background: #fff; color: #e67e22; font-weight: bold; border: 2px solid #e67e22; }

        .scroll-box { max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; position: relative; }
        .course-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; border: 1px solid #dee2e6; }
        .course-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 30; padding: 14px 10px; border: 1px solid #dee2e6; font-weight: 800; }
        
        /* ìš”ì•½ í–‰ ê³ ì • ìŠ¤íƒ€ì¼ ë³µêµ¬ */
        .summary-row td { 
            background-color: #2c3e50 !important; color: #ffffff !important; font-weight: bold; 
            position: sticky; top: 45px; z-index: 25; border-bottom: 3px solid #3498db; padding: 10px; 
        }

        .course-table td { border: 1px solid #dee2e6; text-align: center; vertical-align: middle; background: white; line-height: 1.4; padding: 0; }
        
        .subject-cell { background-color: #f0f7ff; font-weight: bold; color: #2c3e50; border-right: 3px solid #3498db !important; padding: 5px !important; }
        .subject-total-cell { background-color: #fff9f0; font-weight: bold; color: #e67e22; border-left: 3px solid #e67e22 !important; padding: 5px !important; }
        .top-border-thick { border-top: 3px solid #3498db !important; }

        /* ì„¸ë¶€í•­ëª©ìš© ì„œë¸Œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .sub-item-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .sub-item-row { 
            display: flex; align-items: center; justify-content: center; 
            border-bottom: 1px solid #eee; min-height: 35px; box-sizing: border-box; 
        }
        .sub-item-row:last-child { border-bottom: none; }
        
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .editable-input { 
            width: 100%; height: 100%; border: none; background: transparent; 
            text-align: center; font-size: 12px; font-family: inherit;
        }
        .editable-input:focus { background: #fffde7; outline: none; }
        .text-left { text-align: left; padding-left: 10px; }

        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-blue { background: #3498db; color: white; }
        .btn-green { background: #27ae60; color: white; }
        .btn-orange { background: #e67e22; color: white; }
        .btn-red { background: #e74c3c; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸš— ë¶€ì‚° ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</h1>
        <div id="connectionStatus">ì—°ê²° í™•ì¸ ì¤‘...</div>
    </div>

    <div class="top-action-grid">
        <div class="section-card" style="border-top: 4px solid #3498db;">
            <h4 style="margin-top:0;">ğŸ“… ì‹œê°„í‘œ ë“±ë¡ ë° ê´€ë¦¬</h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="file" id="timetableFile" accept=".xlsx, .xls" onchange="processTimetable(this)">
                <div id="fileStatusBox" style="font-size: 12px; color: #2c3e50; font-weight: bold; background: #f0f7ff; padding: 8px; border-radius: 5px; border: 1px solid #3498db; display: none;">
                    ğŸ“„ ì €ì¥ëœ íŒŒì¼: <span id="savedFileName">-</span>
                </div>
                <button id="downloadBtn" class="btn btn-blue" style="display:none;" onclick="downloadSavedTimetable()">ğŸ’¾ ì„œë²„ì— ì €ì¥ëœ ì‹œê°„í‘œ ë‚´ë ¤ë°›ê¸°</button>
            </div>
        </div>
        <div class="section-card" style="border-top: 4px solid #27ae60;">
            <h4 style="margin-top:0;">ğŸ“ ì¶œê²° ê´€ë¦¬ ë° ë¶„ì„</h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-orange" onclick="location.href='ì¼ì¼ì¶œì„ë¶€.html?class=' + currentClass" style="font-size: 14px;">
                    ğŸ“… ë§¤ì¼ ì…/í‡´ì‹¤ ê¸°ë¡ ë“±ë¡ (ì¼ì¼ì¶œì„ë¶€)
                </button>
                <button class="btn btn-green" onclick="location.href='ëŠ¥ë ¥ë‹¨ìœ„ì‹œê°„í‘œ.html?class=' + currentClass" style="font-size: 14px;">
                    ğŸ“Š ëŠ¥ë ¥ë‹¨ìœ„ë³„ ì¶œì„ ë¶„ì„ê¸°ë¡œ ì´ë™
                </button>
            </div>
        </div>
    </div>

    <div class="class-info-bar">
        <a href="select_class.html" class="btn-home">â—€ ë°˜ ì„ íƒ ì´ë™</a>
        <div style="margin-left: auto;">
            <span>í˜„ì¬ í•™ê¸‰: </span>
            <span id="currentClassDisplay" class="current-badge">ë¡œë”© ì¤‘...</span>
        </div>
    </div>

    <div class="section-card">
        <h3 style="margin-top:0;">ğŸ“‹ í›ˆë ¨ ê³¼ì • ê°œìš”</h3>
        <div class="info-grid">
            <div class="info-item"><label>í›ˆë ¨ëª…</label><input type="text" id="trainingName"></div>
            <div class="info-item"><label>í›ˆë ¨ê¸°ê°„</label><input type="text" id="trainingPeriod"></div>
            <div class="info-item"><label>ì´ ì¼ìˆ˜</label><input type="text" id="totalDays" readonly style="background:#f8f9fa;"></div>
            <div class="info-item"><label>ë‹´ë‹¹êµì‚¬</label><input type="text" id="teacherName" readonly style="background:#f8f9fa;"></div>
        </div>
    </div>

    <div class="section-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3>ğŸ“‚ êµê³¼ëª© ìƒì„¸ í˜„í™©</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-orange" onclick="clearAndDefault()">ì´ˆê¸°í™”</button>
                <button class="btn btn-blue" onclick="addCourseRow()">+ ìˆ˜ë™ í–‰ ì¶”ê°€</button>
                <button class="btn btn-blue" style="background-color: #2c3e50;" onclick="downloadCourseTable()">ğŸ“Š ìƒì„¸í˜„í™© ì—‘ì…€ ì¶œë ¥</button>
                <button class="btn btn-green" onclick="saveAllData()">ğŸ’¾ ì „ì²´ ë°ì´í„° ì„œë²„ ì €ì¥</button>
            </div>
        </div>
        <div class="scroll-box">
            <table class="course-table">
                <thead>
                    <tr>
                        <th width="15%">êµê³¼ëª©</th>
                        <th width="20%">ëŠ¥ë ¥ë‹¨ìœ„ëª…</th>
                        <th width="35%">ì„¸ë¶€êµê³¼(ëŠ¥ë ¥ë‹¨ìœ„ìš”ì†Œ)</th>
                        <th width="10%">ë‹¨ìœ„ ì‹œê°„(h)</th>
                        <th width="10%">êµê³¼ëª© ì´ ì‹œê°„</th>
                        <th width="8%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="courseTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "í…ŒìŠ¤íŠ¸";

document.getElementById('currentClassDisplay').innerText = currentClass;

database.ref('.info/connected').on('value', snap => {
    const el = document.getElementById('connectionStatus');
    el.innerText = snap.val() ? "â— ì„œë²„ ì—°ê²°ë¨" : "â—‹ ì—°ê²° ëŠê¹€";
    el.style.color = snap.val() ? "green" : "red";
});

function initializePage() {
    loadData();
    checkTimetableStatus();
}

function checkTimetableStatus() {
    database.ref(`${currentClass}/timetableStorage`).once('value', snap => {
        const info = snap.val();
        if(info && info.fileName) {
            document.getElementById('fileStatusBox').style.display = "block";
            document.getElementById('savedFileName').innerText = info.fileName;
            document.getElementById('downloadBtn').style.display = "block";
        }
    });
}

function processTimetable(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'}); 
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { raw: false });
        
        const map = {}; 
        const dateValues = [];
        const teachers = {};
        const dayValues = [];

        json.forEach(row => {
            if(row['ë‚ ì§œ']) {
                let rawDate = String(row['ë‚ ì§œ']).trim();
                let normalized = "";
                if (rawDate.includes('/')) {
                    let parts = rawDate.split('/');
                    if (parts.length === 3) {
                        let y = parts[2].length === 2 ? "20" + parts[2] : parts[2];
                        let m = parts[0].padStart(2, '0');
                        let d = parts[1].padStart(2, '0');
                        if(y.length === 4 && parseInt(parts[0]) <= 12) normalized = `${y}-${m}-${d}`;
                        else normalized = rawDate.replace(/\//g, '-');
                    }
                } else if (rawDate.includes('.')) {
                    normalized = rawDate.replace(/\./g, '-').substring(0, 10);
                } else {
                    normalized = rawDate.substring(0, 10);
                }
                if (normalized.length === 10) dateValues.push(normalized);
            }
            if(row['ì¼ìˆ˜'] && !isNaN(row['ì¼ìˆ˜'])) dayValues.push(Number(row['ì¼ìˆ˜']));
            const t = row['í›ˆë ¨êµÂ·ê°•ì‚¬'] || row['ê°•ì‚¬ëª…'];
            if(t) teachers[t] = (teachers[t] || 0) + 1;

            const sub = (row['êµê³¼ëª©'] || 'ë¯¸ë¶„ë¥˜').trim();
            const unit = (row['ëŠ¥ë ¥ë‹¨ìœ„ëª…'] || '').trim();
            const det = (row['ì„¸ë¶€êµê³¼'] || 'ë¯¸ì§€ì •').trim();

            if(unit) {
                const key = sub + "|" + unit;
                if(!map[key]) map[key] = { subject: sub, unit: unit, detailMap: {}, total: 0 };
                map[key].detailMap[det] = (map[key].detailMap[det] || 0) + 1;
                map[key].total++;
            }
        });

        const finalResults = Object.values(map).map(v => {
            const details = Object.entries(v.detailMap).map(([name, hour]) => ({ name, hour }));
            return { subject: v.subject, unit: v.unit, details: details, totalHours: v.total };
        });

        if(dateValues.length > 0) {
            const sorted = [...new Set(dateValues)].sort();
            document.getElementById('trainingPeriod').value = `${sorted[0]} ~ ${sorted[sorted.length-1]}`;
        }
        if(dayValues.length > 0) document.getElementById('totalDays').value = Math.max(...dayValues) + "ì¼";
        let topT = ""; let maxC = 0;
        for(let t in teachers) if(teachers[t] > maxC) { topT = t; maxC = teachers[t]; }
        document.getElementById('teacherName').value = topT || "-";

        renderTable(finalResults);
        database.ref(`${currentClass}/timetableStorage`).set({ fileName: file.name, data: json });
        database.ref(`${currentClass}/fullTimetable`).set(json);
        alert("âœ… ì‹œê°„í‘œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };
    reader.readAsArrayBuffer(file);
}

function renderTable(list) {
    const tbody = document.getElementById('courseTableBody');
    tbody.innerHTML = '';
    if(!list || list.length === 0) return;

    let globalHours = 0;
    const grouped = {};

    // 1. ë°ì´í„°ë¥¼ êµê³¼ëª©ë³„ë¡œ ê·¸ë£¹í™”
    list.forEach(item => {
        if(!grouped[item.subject]) {
            grouped[item.subject] = { units: [], total: 0 };
        }
        grouped[item.subject].units.push(item);
        
        // [ìˆ˜ì •] ëŠ¥ë ¥ë‹¨ìœ„ë³„ í•©ê³„ë¥¼ í•œ ë²ˆë§Œ ë”í•¨ (ì¤‘ë³µ í•©ì‚° ë°©ì§€)
        let unitSum = 0;
        item.details.forEach(d => {
            unitSum += Number(d.hour || 0);
        });
        grouped[item.subject].total += unitSum;
        globalHours += unitSum;
    });

    const sortedSub = Object.keys(grouped).sort();

    // 2. ìš”ì•½ í–‰ (ìƒë‹¨ ê³ ì •)
    const summaryTr = document.createElement('tr');
    summaryTr.classList.add('summary-row');
    summaryTr.innerHTML = `
        <td>êµê³¼ëª©: ${sortedSub.length}ì¢…</td>
        <td>ëŠ¥ë ¥ë‹¨ìœ„: ${list.length}ê°œ</td>
        <td>- ê³¼ì • ìš”ì•½ í˜„í™© -</td>
        <td>ì „ì²´: ${globalHours}h</td>
        <td>ì „ì²´: ${globalHours}h</td>
        <td>ìš”ì•½</td>
    `;
    tbody.appendChild(summaryTr);

    // 3. í…Œì´ë¸” ë³¸ë¬¸ ë Œë”ë§
    sortedSub.forEach(sub => {
        const units = grouped[sub].units;
        const subTotal = grouped[sub].total; // í•´ë‹¹ êµê³¼ëª©ì˜ ì •í™•í•œ ì´ í•©ê³„

        units.forEach((unitData, i) => {
            const tr = document.createElement('tr');
            if(i === 0) tr.classList.add('top-border-thick');

            let detailHtml = `<div class="sub-item-container">`;
            let hourHtml = `<div class="sub-item-container">`;
            
            unitData.details.forEach(d => {
                detailHtml += `<div class="sub-item-row"><input type="text" class="editable-input sub-detail-input text-left" value="${d.name}"></div>`;
                hourHtml += `<div class="sub-item-row"><input type="number" class="editable-input sub-hour-input" value="${d.hour}"></div>`;
            });
            detailHtml += `</div>`;
            hourHtml += `</div>`;

            tr.innerHTML = `
                ${i === 0 ? `<td rowspan="${units.length}" class="subject-cell">
                    <input type="text" class="editable-input c-subject-input" value="${sub}" style="font-weight:bold; color:#2c3e50;">
                </td>` : ''}
                <td style="padding:5px;"><input type="text" class="editable-input c-unit-input" value="${unitData.unit}" style="color:#333;"></td>
                <td>${detailHtml}</td>
                <td>${hourHtml}</td>
                ${i === 0 ? `<td rowspan="${units.length}" class="subject-total-cell">
                    <input type="number" class="editable-input c-subtotal-input" value="${subTotal}" style="font-weight:bold; color:#e67e22;">
                </td>` : ''}
                <td><button class="btn btn-red" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
                <input type="hidden" class="c-original-subject" value="${sub}">
            `;
            tbody.appendChild(tr);
        });
    });
}

function saveAllData() {
    const rows = document.querySelectorAll('#courseTableBody tr:not(.summary-row)');
    const courseList = [];
    
    rows.forEach(row => {
        const unitInput = row.querySelector('.c-unit-input');
        if(unitInput) {
            // rowspanëœ êµê³¼ëª©ëª… ì°¾ê¸°
            let subjectName = "";
            if(row.querySelector('.c-subject-input')) {
                subjectName = row.querySelector('.c-subject-input').value;
            } else {
                let prev = row.previousElementSibling;
                while(prev) {
                    if(prev.querySelector('.c-subject-input')) {
                        subjectName = prev.querySelector('.c-subject-input').value;
                        break;
                    }
                    prev = prev.previousElementSibling;
                }
            }

            // ì„¸ë¶€êµê³¼ ë° ì‹œê°„ ìˆ˜ì§‘
            const subDetailInputs = row.querySelectorAll('.sub-detail-input');
            const subHourInputs = row.querySelectorAll('.sub-hour-input');
            const details = [];
            subDetailInputs.forEach((input, idx) => {
                details.push({ name: input.value, hour: subHourInputs[idx].value });
            });

            // êµê³¼ëª© ì´ ì‹œê°„ ì°¾ê¸°
            let subTotal = 0;
            if(row.querySelector('.c-subtotal-input')) {
                subTotal = row.querySelector('.c-subtotal-input').value;
            } else {
                let prev = row.previousElementSibling;
                while(prev) {
                    if(prev.querySelector('.c-subtotal-input')) {
                        subTotal = prev.querySelector('.c-subtotal-input').value;
                        break;
                    }
                    prev = prev.previousElementSibling;
                }
            }

            courseList.push({ 
                subject: subjectName, 
                unit: unitInput.value, 
                details: details, 
                totalHours: subTotal 
            });
        }
    });

    database.ref(`${currentClass}/masterData`).set({
        name: document.getElementById('trainingName').value,
        period: document.getElementById('trainingPeriod').value,
        days: document.getElementById('totalDays').value,
        teacher: document.getElementById('teacherName').value,
        courses: courseList
    }).then(() => alert("âœ… ëª¨ë“  ìˆ˜ì • ì‚¬í•­ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"));
}

function loadData() {
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('trainingName').value = d.name || "";
        document.getElementById('trainingPeriod').value = d.period || "";
        document.getElementById('totalDays').value = d.days || "";
        document.getElementById('teacherName').value = d.teacher || "";
        if(d.courses) renderTable(d.courses);
    });
}

function downloadCourseTable() {
    const rows = document.querySelectorAll('#courseTableBody tr:not(.summary-row)');
    const exportData = [];
    rows.forEach(row => {
        const unitInput = row.querySelector('.c-unit-input');
        if(unitInput) {
            let subjectName = "";
            if(row.querySelector('.c-subject-input')) subjectName = row.querySelector('.c-subject-input').value;
            else {
                let prev = row.previousElementSibling;
                while(prev) {
                    if(prev.querySelector('.c-subject-input')) { subjectName = prev.querySelector('.c-subject-input').value; break; }
                    prev = prev.previousElementSibling;
                }
            }
            const subDetailInputs = row.querySelectorAll('.sub-detail-input');
            const subHourInputs = row.querySelectorAll('.sub-hour-input');
            subDetailInputs.forEach((input, idx) => {
                exportData.push({
                    "êµê³¼ëª©": subjectName,
                    "ëŠ¥ë ¥ë‹¨ìœ„ëª…": unitInput.value,
                    "ì„¸ë¶€êµê³¼": input.value,
                    "ì‹œê°„(h)": subHourInputs[idx].value
                });
            });
        }
    });
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ìƒì„¸í˜„í™©");
    XLSX.writeFile(wb, `[${currentClass}]êµê³¼ëª©_ìƒì„¸í˜„í™©.xlsx`);
}

function addCourseRow() {
    const tbody = document.getElementById('courseTableBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td class="subject-cell"><input type="text" class="editable-input c-subject-input" placeholder="êµê³¼ëª©"></td>
        <td><input type="text" class="editable-input c-unit-input" placeholder="ëŠ¥ë ¥ë‹¨ìœ„"></td>
        <td><div class="sub-item-row"><input type="text" class="editable-input sub-detail-input text-left" placeholder="ì„¸ë¶€êµê³¼"></div></td>
        <td><div class="sub-item-row"><input type="number" class="editable-input sub-hour-input" placeholder="0"></div></td>
        <td class="subject-total-cell"><input type="number" class="editable-input c-subtotal-input" placeholder="0"></td>
        <td><button class="btn btn-red" onclick="this.parentElement.parentElement.remove()">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
}
function clearAndDefault() { if(confirm("ì´ˆê¸°í™”?")) renderTable([]); }

initializePage();
</script>
</body>
</html>