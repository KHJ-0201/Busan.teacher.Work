<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì¶œì„ ê¸°ë¡ ë“±ë¡ | ìë™ì°¨ êµìœ¡ê³¼ì • í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        /* ì„ ìƒë‹˜ ìš”ì²­ëŒ€ë¡œ ì¢Œìš° ì—¬ë°±ì„ ì¤€ ì»¨í…Œì´ë„ˆ ì„¤ì • */
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .header { border-bottom: 3px solid #e67e22; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .info-bar { background: #fff5e6; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e67e22; }
        
        /* ë‚ ì§œ ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .date-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .date-list-table th, .date-list-table td { border: 1px solid #eee; padding: 12px; text-align: center; }
        .date-list-table th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; }
        
        /* ì—…ë¡œë“œ ìƒíƒœ í‘œì‹œ */
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .status-none { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .status-done { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-upload { background: #e67e22; color: white; }
        .btn-nav { background: #34495e; color: white; text-decoration: none; display: inline-block; }
        
        /* ìˆ¨ê²¨ì§„ íŒŒì¼ ì¸í’‹ */
        #hiddenFileInput { display: none; }
        
        .scroll-area { max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        .highlight { color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="margin:0; color:#e67e22;">ğŸ“… ì¼ì¼ ì¶œì„ ë°ì´í„° ê´€ë¦¬ (í›ˆë ¨ì¼ìë³„)</h2>
        <a href="#" class="btn btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <div class="info-bar">
        <div><strong>í•™ê¸‰:</strong> <span id="dispClass" class="highlight">-</span></div>
        <div id="courseInfo" style="font-size: 14px; color: #666;">í›ˆë ¨ ê¸°ê°„ ë¡œë”© ì¤‘...</div>
        <div><strong>ì´ í›ˆë ¨ì¼ìˆ˜:</strong> <span id="totalWorkDays" class="highlight">0</span>ì¼</div>
    </div>

    <div class="section-card">
        <p style="margin-bottom: 10px; font-size: 14px; color: #555;">
            â€» ì•„ë˜ ëª©ë¡ì€ <strong>ì‹œê°„í‘œ(index.html)</strong>ì— ë“±ë¡ëœ ì‹¤ì œ ìˆ˜ì—… ë‚ ì§œë“¤ì…ë‹ˆë‹¤. í•´ë‹¹ ë‚ ì§œì˜ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
        </p>
        <div class="scroll-area">
            <table class="date-list-table">
                <thead>
                    <tr>
                        <th width="15%">í›ˆë ¨ì¼ìˆ˜</th>
                        <th width="20%">ë‚ ì§œ(ìš”ì¼)</th>
                        <th width="40%">ì§„í–‰ êµê³¼ëª©</th>
                        <th width="10%">ìƒíƒœ</th>
                        <th width="15%">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="dateListBody">
                    <tr><td colspan="5" style="padding:50px;">ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<input type="file" id="hiddenFileInput" accept=".xlsx, .xls" onchange="handleFileSelect(this)">

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "í…ŒìŠ¤íŠ¸";
document.getElementById('dispClass').innerText = currentClass;

let rawTimetable = [];
let uploadedDates = {}; // ì´ë¯¸ ì—…ë¡œë“œëœ ë‚ ì§œ ëª©ë¡
let selectedTargetDate = ""; // í˜„ì¬ ì—…ë¡œë“œ ì¤‘ì¸ ë‚ ì§œ ê³ ì •ìš©

// ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
function getFixDate(rawDate) {
    if (!rawDate) return "";
    let s = String(rawDate).trim();
    if (s.includes('/')) {
        let parts = s.split('/');
        if (parts.length === 3) {
            return `${parts[2].length === 2 ? "20"+parts[2] : parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
        }
    }
    return s.replace(/\./g, '-').substring(0, 10);
}

// 1. ì´ˆê¸° ë¡œë“œ: ì‹œê°„í‘œì™€ ì—…ë¡œë“œ í˜„í™© ë™ì‹œ ë¡œë“œ
function initialize() {
    // ë§ˆìŠ¤í„° ì •ë³´ ë¡œë“œ
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('courseInfo').innerText = `${d.name || ""} (${d.period || ""})`;
    });

    // ì—…ë¡œë“œëœ ë‚ ì§œ í˜„í™© ê°ì‹œ
    database.ref(`${currentClass}/dailyAttendance`).on('value', snap => {
        uploadedDates = snap.val() || {};
        renderDateList(); // í˜„í™©ì´ ë°”ë€” ë•Œë§ˆë‹¤ ëª©ë¡ ê°±ì‹ 
    });

    // ì „ì²´ ì‹œê°„í‘œ ë¡œë“œ
    database.ref(`${currentClass}/fullTimetable`).once('value', snap => {
        rawTimetable = snap.val() || [];
        renderDateList();
    });
}

// 2. ë‚ ì§œë³„ ëª©ë¡ ìƒì„±
function renderDateList() {
    const tbody = document.getElementById('dateListBody');
    if (rawTimetable.length === 0) return;

    // ë‚ ì§œë³„ë¡œ êµê³¼ëª© ë¬¶ê¸°
    const dayMap = {};
    rawTimetable.forEach(row => {
        const d = getFixDate(row.ë‚ ì§œ);
        if(!d) return;
        if(!dayMap[d]) dayMap[d] = { 
            date: d, 
            dayNum: row.ì¼ìˆ˜ || "-", 
            weekday: row.ìš”ì¼ || "", 
            subjects: new Set() 
        };
        if(row.êµê³¼ëª© && row.êµì‹œ !== "ì ì‹¬") dayMap[d].subjects.add(row.êµê³¼ëª©);
    });

    const sortedDates = Object.keys(dayMap).sort();
    document.getElementById('totalWorkDays').innerText = sortedDates.length;

    tbody.innerHTML = sortedDates.map(dKey => {
        const info = dayMap[dKey];
        const isDone = uploadedDates[dKey] ? true : false;
        const statusHtml = isDone 
            ? `<span class="status-badge status-done">âœ” ë“±ë¡ì™„ë£Œ</span>` 
            : `<span class="status-badge status-none">ë¯¸ë“±ë¡</span>`;
        
        return `
            <tr>
                <td>${info.dayNum}íšŒì°¨</td>
                <td><strong>${info.date}</strong> (${info.weekday})</td>
                <td style="text-align:left; font-size:12px;">${Array.from(info.subjects).join(', ')}</td>
                <td>${statusHtml}</td>
                <td>
                    <button class="btn btn-upload" onclick="triggerUpload('${info.date}')">
                        ${isDone ? 'ì¬ì—…ë¡œë“œ' : 'íŒŒì¼ì°¾ê¸°'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 3. ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ë‚ ì§œ ê³ ì • ë° íŒŒì¼ì°½ ì—´ê¸°
function triggerUpload(date) {
    selectedTargetDate = date;
    document.getElementById('hiddenFileInput').click();
}

// 4. íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
function handleFileSelect(input) {
    const file = input.files[0];
    if(!file || !selectedTargetDate) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        if(json.length === 0) {
            alert("íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const dailyUpdate = {};
        json.forEach(row => {
            const name = (row['í›ˆë ¨ìƒëª…'] || row['ì„±ëª…'] || "").trim();
            if(name) {
                dailyUpdate[name] = {
                    inTime: row['ì…ì‹¤ì‹œê°„'] || row['ì…ì‹¤'] || "",
                    outTime: row['í‡´ì‹¤ì‹œê°„'] || row['í‡´ì‹¤'] || "",
                    status: row['ì¶œê²°ìƒíƒœ'] || row['ìƒíƒœ'] || "ì •ìƒ",
                    note: row['ë¹„ê³ '] || ""
                };
            }
        });

        // ì§€ì •ëœ ë‚ ì§œ í•˜ìœ„ì— ë°ì´í„° ì €ì¥
        database.ref(`${currentClass}/dailyAttendance/${selectedTargetDate}`).set(dailyUpdate)
            .then(() => {
                // ëŠ¥ë ¥ë‹¨ìœ„ì‹œê°„í‘œì™€ ì—°ë™í•˜ê¸° ìœ„í•œ ì²´í¬ ê¸°ë¡
                database.ref(`${currentClass}/attendance/${selectedTargetDate}`).set(true);
                alert(`[${selectedTargetDate}] ì¶œì„ ë°ì´í„° ì €ì¥ ì™„ë£Œ!`);
                input.value = ""; // íŒŒì¼ ì´ˆê¸°í™”
            })
            .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
    };
    reader.readAsArrayBuffer(file);
}

initialize();
</script>
</body>
</html>