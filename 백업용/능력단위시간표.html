<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¢…í•© ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* [ì„ ìƒë‹˜ ë””ìì¸ ìˆœì • ìœ ì§€] */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .excel-container { max-width: 1400px; margin: 20px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .excel-header-title { text-align: center; font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #27ae60; color: white; border-color: #27ae60; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 20px; width: 100%; }
        .calendar-day { min-height: 120px; border: 1px solid #ddd; padding: 10px; background: white; position: relative; border-radius: 5px; }
        .calendar-day.sun { color: red; background: #fff5f5; }
        .calendar-day.sat { color: blue; background: #f5faff; }
        .day-num { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .subject-tag { display: block; font-size: 11px; padding: 4px 6px; background: #e3f2fd; color: #1976d2; border-radius: 3px; margin-bottom: 4px; line-height: 1.3; white-space: normal; word-break: break-all; }
        .holiday-tag { display: block; font-size: 11px; padding: 4px 6px; background: #fff5f5; color: #e74c3c; border-radius: 3px; margin-bottom: 4px; border: 1px dashed #feb2b2; line-height: 1.3; white-space: normal; word-break: break-all; }
        .attendance-check { position: absolute; bottom: 10px; right: 10px; font-size: 10px; font-weight: bold; color: #27ae60; background: #e8f5e9; padding: 2px 6px; border-radius: 10px; display: none; }
        .attendance-check.done { display: block; border: 1px solid #27ae60; }
        .calendar-ctrl { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; }
        .ctrl-btn { padding: 5px 15px; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .scroll-box { 
    max-height: 800px; /* 23ëª… ê¸°ì¤€ í•œ í™”ë©´ì— ê±°ì˜ ë‹¤ ë“¤ì–´ì˜¤ëŠ” ë†’ì´ */
    overflow-x: auto; 
    overflow-y: auto; 
    border: 1px solid #ccc; 
    position: relative; 
    background: #fff; 
}
        .attendance-table { width: 100%; border-collapse: collapse; font-size: clamp(9px, 0.8vw, 11px); table-layout: fixed; }
        .attendance-table th, .attendance-table td { border: 1px solid #ccc; padding: 4px 2px; text-align: center; word-break: break-all; white-space: normal !important; overflow: hidden; line-height: 1.2; }
        .sticky-col { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 50; border-right: 2px solid #27ae60 !important; font-weight: bold; }
        .btn-nav { padding: 8px 15px; border: 1.5px solid #3498db; border-radius: 4px; cursor: pointer; text-decoration: none; color: #3498db; font-weight: bold; }
        .excel-info-table { width: 100%; border: 2px solid #27ae60; border-collapse: collapse; margin-bottom: 20px; }
        .info-label { background: #f0faf3; font-weight: bold; width: 120px; text-align: center; padding: 10px; border: 1px solid #ccc; }
        .info-value { color: #27ae60; font-weight: bold; padding: 10px; border: 1px solid #ccc; }
        .full-width-cell { padding: 20px !important; background: #fff; }
        .btn-excel { background-color: #1d6f42 !important; color: white !important; padding: 5px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; margin-right: 5px; }
        .sort-control { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; justify-content: flex-end; }
        .subject-dashboard-item { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .subject-summary-bar { display: grid; grid-template-columns: 2.5fr 2fr 1fr 1fr; align-items: center; padding: 15px 20px; cursor: pointer; background: #f8f9fa; transition: 0.2s; }
        .subject-summary-bar:hover { background: #e9ecef; }
        .summary-name { font-weight: bold; color: #2c3e50; font-size: 14px; }
        .summary-period { font-size: 12px; color: #6c757d; text-align: center; }
        .summary-total { font-weight: bold; color: #27ae60; text-align: center; font-size: 13px; }
        .detail-view { 
    display: none; 
    padding: 20px; 
    border-top: 2px solid #27ae60; /* êµ¬ë¶„ì„  ê°•í™” */
    background: #fafafa; 
    min-height: 600px; /* ì°½ì´ ì—´ë¦´ ë•Œ ìµœì†Œ ë†’ì´ í™•ë³´ */
}
        .edit-input { width: 100%; border: none; background: transparent; text-align: center; font-size: 11px; padding: 2px 0; font-family: inherit; }
        .edit-input:focus { background-color: #fffde7; outline: 1px solid #27ae60; }
        .edit-input::-webkit-inner-spin-button, .edit-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .manual-modified { background-color: #fff3e0 !important; font-weight: bold; color: #e67e22; }

        .status-late { background-color: #fff176 !important; color: #856404 !important; font-weight: bold; } /* ì§€ê°/ì¡°í‡´: ì§„í•œ ë…¸ë‘ */
        .status-out { background-color: #e8f5e9 !important; color: #27ae60; font-weight: bold; }  /* ì™¸ì¶œ: ì´ˆë¡ */
        .status-absent { background-color: #ffebee !important; color: #e74c3c; font-weight: bold; } /* ê²°ì„: ë¹¨ê°• */
        .status-special { background-color: #e3f2fd !important; color: #3498db; font-weight: bold; } /* íœ´ê°€/ê³µê°€/ê¸°íƒ€: í•˜ëŠ˜ */

        /* íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
}
.modal-content {
    background: white; width: 90%; max-width: 1200px; max-height: 90vh;
    border-radius: 15px; padding: 30px; overflow-y: auto; position: relative;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}
.close-modal {
    position: absolute; top: 15px; right: 20px; font-size: 24px;
    cursor: pointer; color: #666; font-weight: bold;
}

        @media print {
            @page { 
                size: A4 landscape; 
                margin: 5mm; 
            }
            body { 
                background: white !important; 
                color: black !important; 
                padding: 0 !important; 
                -webkit-print-color-adjust: exact; 
            }

            /* ë¶ˆí•„ìš” ìš”ì†Œ ì œê±° */
            .excel-container, .btn-nav, .tab-menu, .calendar-ctrl, .ctrl-btn, .btn-excel, .excel-header-title, #subjectFilterRow, .sort-control, .subject-summary-bar, #topActionArea { 
                display: none !important; 
            }
            
            #printOnlyArea { 
                display: block !important; 
                width: 100% !important; 
            }
            
            /* 1. ìƒë‹¨ ì œëª©: ê°€ë…ì„±ì„ ìœ„í•´ í¬ê¸° ìœ ì§€ */
            #printSubjectTitle { 
                display: block !important; 
                text-align: center; 
                font-size: 20px !important; 
                font-weight: bold; 
                margin-bottom: 8px !important; 
                border-bottom: 2px solid #000; 
            }

            /* 2. ê³¼ì • ì •ë³´: ì¡°ê¸ˆ ë” í¬ê²Œ ê°•ì¡° */
            #printOnlyArea .excel-info-table {
                margin-bottom: 10px !important; 
                border: 1.5px solid #000 !important;
            }
            #printOnlyArea .info-label {
                background: #f2f2f2 !important;
                font-size: 10pt !important;
                padding: 6px !important;
            }
            #printOnlyArea .info-value {
                font-size: 10pt !important;
                padding: 6px !important;
                color: #000 !important;
            }

            /* 3. ë©”ì¸ í‘œ ì„¤ì • */
            .scroll-box { max-height: none !important; overflow: visible !important; }
            .attendance-table { 
                width: 100% !important; 
                border: 1.5px solid black !important; 
                border-collapse: collapse !important;
                table-layout: fixed !important; 
            }

            /* 4. í•™ìƒ ëª…ë‹¨ ë†’ì´ ê· ì¼í™” ë° ë‹¤ì´ì–´íŠ¸ (í•µì‹¬ ìˆ˜ë¦¬) */
            .attendance-table th, .attendance-table td { 
                border: 1px solid black !important; 
                padding: 0px 1px !important; 
                line-height: 1.0 !important; 
                /* 23ëª… ê¸°ì¤€ í•œ ì¥ì— ì™ ë“¤ì–´ì˜¤ëŠ” ë§ˆë²•ì˜ ë†’ì´ */
                height: 19px !important; 
                font-size: 7.5pt !important;
            }

            /* ì„±ëª… ì¹¸: í•œ ì¤„ ê³ ì • */
            .attendance-table td:first-child, 
            .attendance-table th:first-child {
                width: 75px !important;
                white-space: nowrap !important;
                font-size: 8.5pt !important;
                font-weight: bold !important;
            }

            /* í—¤ë”(ë‚ ì§œ/êµì‹œ) ë†’ì´ë§Œ ì‚´ì§ ì—¬ìœ  */
            .attendance-table thead tr {
                height: 22px !important;
            }

            .sticky-col { position: static !important; background: white !important; }

            /* ìƒíƒœë³„ ë°°ê²½ìƒ‰ ê°•ì œ ì¶œë ¥ */
            .status-late { background-color: #fff176 !important; -webkit-print-color-adjust: exact; }
            .status-out { background-color: #e8f5e9 !important; -webkit-print-color-adjust: exact; }
            .status-absent { background-color: #ffebee !important; -webkit-print-color-adjust: exact; }
            .status-special { background-color: #e3f2fd !important; -webkit-print-color-adjust: exact; }
            .print-page-break { page-break-after: always; } /* ì´ í´ë˜ìŠ¤ê°€ ë¶™ì€ div ë’¤ì—ì„œ í˜ì´ì§€ ë„˜ê¹€ */
        }
        #printOnlyArea { display: none; }
        .btn-rate { padding: 8px 15px; border: 1.5px solid #8e44ad; border-radius: 4px; cursor: pointer; text-decoration: none; color: #8e44ad; font-weight: bold; }
    </style>

<div id="calendarModal" class="modal-overlay" onclick="closeCalendarModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="document.getElementById('calendarModal').style.display='none'">Ã—</span>
        <h3 id="modalTitle" style="color: #27ae60; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">ê³¼ëª© ìƒì„¸ ì •ë³´</h3>
        <div id="modalActionArea" style="display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 10px;">
            </div>
        <div class="scroll-box">
            <table class="attendance-table">
                <thead id="modalHead"></thead>
                <tbody id="modalBody"></tbody>
            </table>
        </div>
    </div>
</div>
</head>
<body>


<div class="excel-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="display: flex; gap: 10px;">
             <a href="#" class="btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ ë©”ì¸ìœ¼ë¡œ</a>
             <a href="#" class="btn-rate" onclick="location.href='ë‹¨ìœ„ê°œì›”ì¶œì„ë¶€.html?class=' + currentClass">ğŸ“ˆ ë‹¨ìœ„ê°œì›” ì¶œì„ë¶€ ë³´ê¸°</a>
             <a href="#" class="btn-nav" style="border-color: #e67e22; color: #e67e22;" onclick="location.href='ì¼ì¼ì¶œì„ë¶€.html?class=' + currentClass">ğŸ“ ì¼ì¼ì¶œì„ë¶€ ë“±ë¡</a>
        </div>
        <button class="btn-nav" style="border-color: #e74c3c; color: #e74c3c; background: #fff5f5; font-size: 11px;" onclick="resetAllManualData()">âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>

    <div style="text-align: right; margin-bottom: 15px;">
        <span style="font-weight:bold; color:#27ae60; background: #e8f5e9; padding: 5px 15px; border-radius: 20px; border: 1px solid #27ae60;">
            ğŸ“ í˜„ì¬ í•™ê¸‰: <span id="dispClass">-</span>
        </span>
    </div>
    <div class="excel-header-title">ì¢…í•© ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
    <div class="tab-menu">
        <div class="tab-btn active" onclick="changeMode('subject')">ê³¼ëª©ë³„ ë³´ê¸°</div>
        <div class="tab-btn" onclick="changeMode('ncs')">ëŠ¥ë ¥ë‹¨ìœ„ë³„ ë³´ê¸°</div>
        <div class="tab-btn" onclick="changeMode('calendar')">ìš”ì¼ë³„(ë‹¬ë ¥) ë³´ê¸°</div>
        <div class="tab-btn" onclick="changeMode('weekly')">ì£¼ì°¨ë³„ ë³´ê¸°</div>
    </div>
    <div id="topActionArea" style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 2px solid #27ae60; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div id="actionLabel" style="font-weight: bold; color: #1b5e20;">ğŸ–¨ï¸ ì¸ì‡„/ì—‘ì…€ ëŒ€ìƒ ì„ íƒ:</div>
            <select id="actionSubjectSelect" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold;">
                <option value="">êµê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
            <button class="ctrl-btn" onclick="executeAction('print')" style="background: #34495e;">ğŸ“„ ì„ íƒ ì¸ì‡„</button>
            <button class="ctrl-btn" onclick="executeAllPrint()" style="background: #2c3e50; border: 1px solid #000;">ğŸ“‘ ì „ì²´ ê³¼ëª© ì¼ê´„ ì¸ì‡„</button>
            <button class="btn-excel" onclick="executeAction('excel')" style="height: 34px;">ğŸ“Š ì„ íƒ ì—‘ì…€ ì €ì¥</button>
        </div>
    </div>
    <table class="excel-info-table">
        <tr>
            <td class="info-label">í›ˆë ¨ê³¼ì • :</td><td class="info-value" id="infoCourse">-</td>
            <td class="info-label">í›ˆë ¨ê¸°ê°„ :</td><td class="info-value" id="infoPeriod">-</td>
        </tr>
        <tr id="subjectFilterRow">
            <td colspan="4" class="full-width-cell">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <div id="dashboardTitle" style="font-weight: bold; font-size: 16px; color: #27ae60;">ğŸ“˜ êµê³¼ëª© ìƒì„¸ ëª©ë¡</div>
                    <div class="sort-control">
                        <button class="ctrl-btn" onclick="renderSubjectList('name')" style="font-size: 12px;">ğŸ”¤ ëª…ì¹­ìˆœ</button>
                        <button class="ctrl-btn" onclick="renderSubjectList('date')" style="font-size: 12px;">ğŸ“… ë‚ ì§œìˆœ</button>
                    </div>
                </div>
                <div id="subjectDashboardArea"></div>
            </td>
        </tr>
    </table>
    <div id="viewArea"></div>
</div>

<div id="printOnlyArea">
    <div id="printSubjectTitle">ì¶œì„ë¶€: <span id="targetSubName">-</span></div>
    <table class="excel-info-table">
        <tr>
            <td class="info-label">í›ˆë ¨ê³¼ì • :</td><td class="info-value" id="pInfoCourse">-</td>
            <td class="info-label">í›ˆë ¨ê¸°ê°„ :</td><td class="info-value" id="pInfoPeriod">-</td>
        </tr>
    </table>
    <div class="scroll-box">
        <table class="attendance-table" id="actionTargetTable">
            <thead id="pHead"></thead>
            <tbody id="pBody"></tbody>
        </table>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.app",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "í…ŒìŠ¤íŠ¸";
document.getElementById('dispClass').innerText = currentClass;

let rawTimetable = [], masterSubjectList = [], ncsList = [], studentNames = [], fullAttendanceData = {}, currentMode = 'subject', calYear, calMonth, weeklySubMode = 'subject';
let evaluationDates = {};

function getFixDate(rawDate) {
    if (!rawDate) return "ë‚ ì§œë¯¸ìƒ";
    let s = String(rawDate).trim();
    s = s.replace(/\./g, '-');
    if (s.includes('/')) {
        let p = s.split('/');
        if (p.length === 3) {
            let year = p[2].length === 2 ? "20" + p[2] : p[2];
            let month = p[0].padStart(2, '0');
            let day = p[1].padStart(2, '0');
            s = `${year}-${month}-${day}`;
        }
    }
    return s.substring(0, 10);
}

function isActualSubject(subName) {
    if (!subName || subName === "") return false;
    const cleanSubName = String(subName).replace(/\s+/g, "");
    return masterSubjectList.some(m => m.replace(/\s+/g, "").includes(cleanSubName)) || 
           ncsList.some(n => n.replace(/\s+/g, "").includes(cleanSubName));
}

async function initialize() {
    database.ref(`${currentClass}/evaluationDates`).on('value', snap => {
        evaluationDates = snap.val() || {};
        if(currentMode === 'calendar') renderCalendar(); // ë°ì´í„°ê°€ ë°”ë€Œë©´ ë‹¬ë ¥ì„ ìƒˆë¡œ ê³ ì¹©ë‹ˆë‹¤.
    });
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('infoCourse').innerText = d.name || "-";
        document.getElementById('infoPeriod').innerText = d.period || "-";
        document.getElementById('pInfoCourse').innerText = d.name || "-";
        document.getElementById('pInfoPeriod').innerText = d.period || "-";
        if(d.courses) {
            masterSubjectList = [...new Set(d.courses.map(c => c.subject))];
            ncsList = [...new Set(d.courses.filter(c => c.unit).map(c => c.unit))];
        }
        updateActionSelect();
        renderSubjectList('name');
    });

    database.ref(`${currentClass}/fullTimetable`).on('value', snap => {
        rawTimetable = snap.val() || [];
        if(rawTimetable.length > 0 && calYear === undefined) {
            const firstDate = getFixDate(rawTimetable[0].ë‚ ì§œ);
            const p = firstDate.split('-');
            calYear = parseInt(p[0]); calMonth = parseInt(p[1]) - 1;
        }
    });

    database.ref(`${currentClass}/dailyAttendance`).on('value', snap => {
        fullAttendanceData = snap.val() || {};
        // [ìˆ˜ë¦¬ í•µì‹¬] íŠ¹ì • ë‚ ì§œê°€ ì•„ë‹ˆë¼ ì „ì²´ ë°ì´í„°ì—ì„œ í•™ìƒ ì´ë¦„ì„ ê¸ì–´ëª¨ìë‹ˆë‹¤.
        let allStudents = new Set();
        Object.values(fullAttendanceData).forEach(dayData => {
            Object.keys(dayData).forEach(name => allStudents.add(name));
        });
        studentNames = Array.from(allStudents).sort();
        if (!studentNames.length) studentNames = ["í›ˆë ¨ìƒ"];
        renderSubjectList('name');
    });
}

function updateActionSelect() {
    const sel = document.getElementById('actionSubjectSelect');
    sel.innerHTML = `<option value="">${currentMode === 'subject' ? 'êµê³¼ëª©' : 'ëŠ¥ë ¥ë‹¨ìœ„'}ì„ ì„ íƒí•˜ì„¸ìš”</option>`;
    const targetList = currentMode === 'subject' ? masterSubjectList : ncsList;
    targetList.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item; opt.innerText = item;
        sel.appendChild(opt);
    });
}

async function executeAction(type) {
    const subName = document.getElementById('actionSubjectSelect').value;
    if(!subName) return alert("ëŒ€ìƒì„ ë¨¼ì € ìƒë‹¨ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
    
    // 1. ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (pHead, pBody IDë¥¼ ê°€ì§„ í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì±„ì›€)
    await loadDetailInto(subName, 'pHead', 'pBody');
    document.getElementById('targetSubName').innerText = subName;

    let fileName = (currentMode === 'subject') ? 
        `${subName} ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ë¶€` : 
        `(${rawTimetable.find(r => String(r.ëŠ¥ë ¥ë‹¨ìœ„ || "").trim() === subName.trim())?.êµê³¼ëª© || "ë¯¸ë¶„ë¥˜"})${subName} ì¶œì„ë¶€`;
    document.title = fileName;

    // 2. ë°ì´í„°ê°€ í…Œì´ë¸”ì— ê·¸ë ¤ì§ˆ ì‹œê°„ì„ 800ms ì •ë„ í™•ë³´í•œ í›„ ì‹¤í–‰
    setTimeout(() => {
        if(type === 'print') {
            window.print();
            document.title = "ì¢…í•© ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ";
        }
        else if(type === 'excel') {
            // ìœ„ HTMLì—ì„œ ë§Œë“  IDë¥¼ ì •í™•íˆ í˜¸ì¶œí•©ë‹ˆë‹¤.
            const table = document.getElementById('actionTargetTable');
            
            if(!table || table.querySelectorAll('tr').length < 2) {
                return alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }

            const wb = XLSX.utils.book_new();
            const rows = [];
            const merges = [];

            const titleLabel = currentMode === 'subject' ? "ğŸ“˜ êµê³¼ëª© ì¶œì„ë¶€" : "ğŸ“œ ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ë¶€";
            rows.push([titleLabel, subName]);
            rows.push(["í›ˆë ¨ê³¼ì •", document.getElementById('infoCourse').innerText]);
            rows.push(["í›ˆë ¨ê¸°ê°„", document.getElementById('infoPeriod').innerText]);
            rows.push([]); 

            for(let i=0; i<3; i++) {
                merges.push({ s: { r: i, c: 1 }, e: { r: i, c: 9 } });
            }

            const startDataRow = rows.length; 
            const trs = table.querySelectorAll('tr');
            const skipMap = {}; 

            trs.forEach((tr, rIdx) => {
                const rowData = [];
                const tds = tr.querySelectorAll('th, td');
                const currentRowIdx = startDataRow + rIdx;
                let currentColIdx = 0;

                tds.forEach((td) => {
                    while (skipMap[`${currentRowIdx}-${currentColIdx}`]) {
                        rowData[currentColIdx] = "";
                        currentColIdx++;
                    }

                    // ìˆ˜ë™ ì…ë ¥ ê°’(input)ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜´
                    const input = td.querySelector('input');
                    const text = input ? (input.value || "0") : td.innerText.trim();
                    const colspan = parseInt(td.getAttribute('colspan') || "1");
                    const rowspan = parseInt(td.getAttribute('rowspan') || "1");

                    rowData[currentColIdx] = text;

                    if (colspan > 1 || rowspan > 1) {
                        merges.push({
                            s: { r: currentRowIdx, c: currentColIdx },
                            e: { r: currentRowIdx + rowspan - 1, c: currentColIdx + colspan - 1 }
                        });
                        if (rowspan > 1) {
                            for (let i = 1; i < rowspan; i++) {
                                for (let j = 0; j < colspan; j++) {
                                    skipMap[`${currentRowIdx + i}-${currentColIdx + j}`] = true;
                                }
                            }
                        }
                        for (let i = 1; i < colspan; i++) {
                            currentColIdx++;
                            rowData[currentColIdx] = "";
                        }
                    }
                    currentColIdx++;
                });
                rows.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!merges'] = merges; 
            const wscols = [{wch: 12}]; 
            for(let i=1; i<50; i++) wscols.push({wch: 6});
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "ì¶œì„ë¶€");
            XLSX.writeFile(wb, `${fileName}.xlsx`);
        }
    }, 800); 
}

async function renderSubjectList(sortType) {
    const area = document.getElementById('subjectDashboardArea');
    const dashboardTitle = document.getElementById('dashboardTitle'); 
    if(!rawTimetable.length) return;

    const targetBaseList = currentMode === 'subject' ? masterSubjectList : ncsList;
    
    let totalAllMin = 0;

    // 2. ë³´ê°• ë°ì´í„°ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ìˆ˜ë™ ì¶œì„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const manualSnap = await database.ref(`${currentClass}/manualAttendance`).once('value');
    const manualData = manualSnap.val() || {};

    let summary = targetBaseList.map(item => {
        const subData = rawTimetable.filter(r => {
            const targetVal = currentMode === 'subject' ? String(r.êµê³¼ëª© || "") : String(r.ëŠ¥ë ¥ë‹¨ìœ„ || "");
            return targetVal.trim() === item;
        });
        
        // [ë¡œì§] ë“±ë¡ ì™„ë£Œ ì²´í¬
        const subDates = [...new Set(subData.map(r => getFixDate(r.ë‚ ì§œ)))];
        const isCompleted = subDates.length > 0 && subDates.every(date => fullAttendanceData[date]);
        const completeBadge = isCompleted ? `<span style="color:#27ae60; margin-left:8px; font-size:12px;">(ì™„ë£Œ)</span>` : "";

        // [ë¡œì§] ë³´ê°• ë°ì´í„° ì²´í¬ (í•´ë‹¹ ê³¼ëª© í‚¤ê°’ìœ¼ë¡œ 0ë¶„ë³´ë‹¤ í° ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸)
        let hasMakeup = false;
        Object.values(manualData).forEach(user => {
            if (user[`makeup_${item}`] > 0) hasMakeup = true;
        });
        const makeupBadge = hasMakeup ? `<span style="color:#e67e22; margin-left:8px; font-size:12px;">(ë³´ê°•)</span>` : "";

        let displayTitle = item;
        if (currentMode === 'ncs' && subData.length > 0) {
            const parentSubject = subData[0].êµê³¼ëª© || "ë¯¸ë¶„ë¥˜";
            displayTitle = `(${parentSubject}) ${item}`;
        }
        
        const dates = subData.map(r => getFixDate(r.ë‚ ì§œ)).sort();
        let min = 0;
        subData.forEach(r => { 
            if(String(r.êµì‹œ).trim() !== "ì ì‹¬") {
                min += 60; 
                totalAllMin += 60; 
            }
        });
        
        return { 
            name: item, 
            displayTitle: displayTitle, 
            completeBadge: completeBadge, 
            makeupBadge: makeupBadge,
            isCompleted: isCompleted, 
            start: dates[0] || "ë¯¸ìƒ", 
            end: dates[dates.length-1] || "ë¯¸ìƒ", 
            min: min, 
            hour: (min/60).toFixed(1) 
        };
    });

    // ìƒë‹¨ í†µê³„ ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
    const totalAllHour = (totalAllMin / 60).toFixed(1);
    const totalCount = summary.length;
    const countLabel = currentMode === 'subject' ? "ê³¼ëª©" : "ë‹¨ìœ„";
    const titleText = currentMode === 'subject' ? "ğŸ“˜ êµê³¼ëª© ìƒì„¸ ëª©ë¡" : "ğŸ“œ ëŠ¥ë ¥ë‹¨ìœ„ ìƒì„¸ ëª©ë¡";
    
    dashboardTitle.innerHTML = `${titleText} <span style="margin-left:15px; font-size:13px; color:#666; font-weight:normal;">(ì´ <b style="color:#3498db;">${totalCount}ê°œ</b> ${countLabel} / ì´í•©: <b style="color:#e67e22;">${totalAllMin.toLocaleString()}ë¶„</b> / <b style="color:#27ae60;">${totalAllHour}h</b>)</span>`;

    if(sortType === 'name') summary.sort((a,b) => a.name.localeCompare(b.name));
    else summary.sort((a,b) => a.start.localeCompare(b.start));
    
    let html = "";
    summary.forEach((item, idx) => {
        const statusIcon = item.isCompleted ? 'âœ…' : (currentMode === 'subject' ? 'ğŸ“˜' : 'ğŸ“œ');
        
        html += `<div class="subject-dashboard-item">
            <div class="subject-summary-bar" onclick="toggleDetail('detailBox_${idx}', '${item.name}')">
                <div class="summary-name">${statusIcon} ${item.displayTitle}${item.completeBadge}${item.makeupBadge}</div>
                <div class="summary-period">ğŸ“… ${item.start} ~ ${item.end}</div>
                <div class="summary-total">â±ï¸ ${item.min}ë¶„</div>
                <div class="summary-total">ğŸ“Š ${item.hour}h</div>
            </div>
            <div id="detailBox_${idx}" class="detail-view">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                    <div style="display: flex; gap: 15px; margin-right: 20px; font-size: 11px; font-weight: bold; align-items: center;">
                        <span style="display: flex; align-items: center;"><i style="width:12px; height:12px; background:#fff176; border:1px solid #f1c40f; display:inline-block; margin-right:4px;"></i>ì§€ê°/ì¡°í‡´</span>
                        <span style="display: flex; align-items: center;"><i style="width:12px; height:12px; background:#e8f5e9; border:1px solid #27ae60; display:inline-block; margin-right:4px;"></i>ì™¸ì¶œ</span>
                        <span style="display: flex; align-items: center;"><i style="width:12px; height:12px; background:#ffebee; border:1px solid #e74c3c; display:inline-block; margin-right:4px;"></i>ê²°ì„</span>
                        <span style="display: flex; align-items: center;"><i style="width:12px; height:12px; background:#e3f2fd; border:1px solid #3498db; display:inline-block; margin-right:4px;"></i>ê³µê°€/íœ´ê°€/ê¸°íƒ€</span>
                    </div>
                    <button class="btn-excel" onclick="saveManualAttendance()" style="background-color: #e67e22 !important; font-size: 12px; padding: 8px 15px;">ğŸ’¾ í˜„ì¬ ìˆ˜ì •ì‚¬í•­ ì´ ê³¼ëª©ì— ì €ì¥</button>
                </div>
                <div class="scroll-box"><table class="attendance-table" id="table_${idx}"><thead id="head_${idx}"></thead><tbody id="body_${idx}"></tbody></table></div>
            </div>
        </div>`;
    });
    area.innerHTML = html;
}

function toggleDetail(boxId, subName) {
    const box = document.getElementById(boxId);
    if(box.style.display === "block") {
        box.style.display = "none";
    } else {
        // ë‹¤ë¥¸ ì—´ë ¤ìˆëŠ” ì°½ ë‹«ê¸°
        document.querySelectorAll('.detail-view').forEach(el => el.style.display = 'none');
        
        // ìƒì„¸ ë‚´ìš© í¼ì¹˜ê¸°
        box.style.display = "block";
        loadDetailInto(subName, 'head_' + boxId.split('_')[1], 'body_' + boxId.split('_')[1]);

        // [ìˆ˜ì •] ê³¼ëª©ëª…ì´ ë³´ì´ë„ë¡ ì—¬ìœ  ìˆê²Œ ìŠ¤í¬ë¡¤ (ì°¨ê°„ ê±°ë¦¬ í™•ë³´)
        setTimeout(() => {
            const item = box.parentElement; // ê³¼ëª©ë°”ì™€ ìƒì„¸ì°½ì„ í¬í•¨í•œ ì „ì²´ ì•„ì´í…œ
            const offset = 80; // í™”ë©´ ìƒë‹¨ì—ì„œ ë„ìš¸ ê±°ë¦¬ (ì´ ê°’ì´ ì»¤ì§ˆìˆ˜ë¡ ê³¼ëª©ëª…ì´ ì•„ë˜ë¡œ ë‚´ë ¤ì˜´)
            const targetPos = item.getBoundingClientRect().top + window.pageYOffset - offset;
            
            window.scrollTo({
                top: targetPos,
                behavior: 'smooth'
            });
        }, 150); // í‘œê°€ ê·¸ë ¤ì§€ëŠ” ì‹œê°„ì„ ê³ ë ¤í•´ ì‚´ì§ ì§€ì—°
    }
}

async function loadDetailInto(selectedSub, headId, bodyId, mode = 'real') {
    // ê³µë°±ì„ ì‹¹ ì œê±°í•˜ê³  ë¹„êµí•˜ë„ë¡ ì—”ì§„ì„ íŠœë‹í•©ë‹ˆë‹¤.
    const cleanSelected = String(selectedSub).replace(/\s+/g, "");
    
    const dates = [...new Set(rawTimetable.filter(r => {
        const rowVal = (currentMode === 'subject' ? (r.êµê³¼ëª© || "") : (r.ëŠ¥ë ¥ë‹¨ìœ„ || ""));
        return String(rowVal).replace(/\s+/g, "") === cleanSelected;
    }).map(r => getFixDate(r.ë‚ ì§œ)))].sort();
    
    const manualSnap = await database.ref(`${currentClass}/manualAttendance`).once('value');
    const manualData = manualSnap.val() || {};
    
    const studentResults = {}, masterSchedule = {}, dateWithDay = {}, weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    studentNames.forEach(name => studentResults[name] = { dates: {}, totalMin: 0, makeupMin: 0 });

    dates.forEach(date => {
        dateWithDay[date] = date + " (" + weekDays[new Date(date).getDay()] + ")";
        masterSchedule[date] = calculateParticipation(date, "09:00", "17:30", selectedSub, "", "");
        
        studentNames.forEach(name => {
            const att = (fullAttendanceData[date] && fullAttendanceData[date][name]) ? fullAttendanceData[date][name] : null;
            let calc = { am: 0, pm: 0, isFuture: !att }; 

            if (att && att.inTime && att.outTime) {
                calc = calculateParticipation(date, att.inTime, att.outTime, selectedSub, att.leaveTime || "", att.returnTime || "");
                calc.isFuture = false;
            }
            if (manualData[name] && manualData[name][date]) {
                if (manualData[name][date].am !== undefined) { calc.am = manualData[name][date].am; calc.am_manual = true; }
                if (manualData[name][date].pm !== undefined) { calc.pm = manualData[name][date].pm; calc.pm_manual = true; }
                calc.isFuture = false;
            }
            if (manualData[name] && manualData[name][`makeup_${selectedSub}`]) {
                studentResults[name].makeupMin = parseInt(manualData[name][`makeup_${selectedSub}`]) || 0;
            }
            studentResults[name].dates[date] = calc; 
        });
    });
    // ì—¬ê¸°ì„œ headIdì™€ bodyIdê°€ ì¸ì‡„ìš© ì•„ì´ë””(pHead, pBody)ì¸ì§€ í™•ì¸í•˜ê³  ì¶œë ¥í•©ë‹ˆë‹¤.
    renderFinalTable(dates, studentResults, masterSchedule, dateWithDay, headId, bodyId, selectedSub, mode);
}

function renderFinalTable(dates, results, masterSchedule, dateWithDay, headId, bodyId, selectedSub, mode) {
    const thead = document.getElementById(headId), tbody = document.getElementById(bodyId);
    if (!thead || !tbody) return;

    // [ê¸°ì¡´ ë²„íŠ¼ ìƒì„± ë¡œì§ ìœ ì§€]
    if (headId !== 'pHead') { 
        const parentBox = thead.closest('.detail-view');
        if (parentBox) {
            const legendArea = parentBox.querySelector('div[style*="justify-content: flex-end"]');
            if (legendArea) {
                const btnHtml = mode === 'real' 
                    ? `<button class="ctrl-btn" onclick="loadDetailInto('${selectedSub}', '${headId}', '${bodyId}', 'sim')" style="background:#8e44ad; font-size:11px; padding:5px 10px; margin-right:10px;">ğŸ”® ë‚¨ì€ì¼ìˆ˜ ì¶œê²°ë¥  ë³´ê¸°</button>`
                    : `<button class="ctrl-btn" onclick="loadDetailInto('${selectedSub}', '${headId}', '${bodyId}', 'real')" style="background:#34495e; font-size:11px; padding:5px 10px; margin-right:10px;">âª ì‹¤ì œ ì¶œê²°ë§Œ ë³´ê¸°</button>`;
                const existingBtn = legendArea.querySelector('.ctrl-btn:not([onclick*="saveManualAttendance"])');
                if(existingBtn) existingBtn.remove();
                legendArea.insertAdjacentHTML('afterbegin', btnHtml);
            }
        }
    }

    // [ìˆ˜ì • í¬ì¸íŠ¸ 1] í…Œì´ë¸” í—¤ë” êµ¬ì„± (ìš”ì¼ ë¶€ë¶„ë§Œ í•˜ì´ë¼ì´íŠ¸)
    let h1 = `<tr><th rowspan="2" class="sticky-col">í›ˆë ¨ìƒëª…</th>`;
    let h2 = `<tr>`;
    dates.forEach(d => { 
        // í´ë¦­í•œ ë‚ ì§œì¸ì§€ í™•ì¸
        const isTarget = (d === window.lastSelectedDate);
        // í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼: í´ë¦­í•œ ë‚ ì§œë©´ ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ì™€ ë°°ê²½ìƒ‰ ì ìš©
        const headStyle = isTarget ? `background:#fff3e0; border:2px solid #e67e22 !important; color:#e67e22;` : `background:#f8f9fa;`;
        const subStyle = isTarget ? `background:#fffef0; font-weight:bold;` : ``;

        h1 += `<th colspan="2" style="${headStyle}">${dateWithDay[d]}</th>`; 
        h2 += `<th style="${subStyle}">ì˜¤ì „</th><th style="${subStyle}">ì˜¤í›„</th>`; 
    });
    h1 += `<th rowspan="2" style="background:#e3f2fd; width:55px;">ë³´ê°•(ë¶„)</th>`;
    h1 += `<th colspan="2">ëˆ„ê³„</th><th rowspan="2" style="width:70px;">ì¶œì„ë¥ </th></tr>`; 
    h2 += `<th>ë¶„</th><th>ì‹œê°„</th></tr>`;
    thead.innerHTML = h1 + h2;

    let masterTotal = 0;
    dates.forEach(d => masterTotal += (masterSchedule[d].am + masterSchedule[d].pm));

    // ìµœìƒë‹¨ í¸ì„± ì‹œê°„ í–‰ ìƒì„±
    let masterRowHtml = `<tr style="background:#f1f8e9; font-weight:bold; color:#2e7d32;">
        <td class="sticky-col">[í¸ì„± ì‹œê°„]</td>`;
    dates.forEach(d => {
        masterRowHtml += `<td>${masterSchedule[d].am}</td><td>${masterSchedule[d].pm}</td>`;
    });
    masterRowHtml += `<td style="background:#e8f5e9;">-</td>
        <td>${masterTotal}</td>
        <td>${(masterTotal/60).toFixed(1)}h</td>
        <td style="color:#2e7d32;">100%</td>
    </tr>`;

    // [ìˆ˜ì • í¬ì¸íŠ¸ 2] í•™ìƒ ë°ì´í„° ìƒì„± (ì¶œì„ ì¹¸ ìŠ¤íƒ€ì¼ ì œê±°, ìˆœì • ìœ ì§€)
    let studentHtml = studentNames.map(name => {
        let rowTotalMin = 0;
        let dateCells = "";
        
        dates.forEach(d => {
            const res = results[name].dates[d];
            const attInfo = (fullAttendanceData[d] && fullAttendanceData[d][name]) ? fullAttendanceData[d][name] : {};
            let amV = res.am;
            let pmV = res.pm;
            let cellClass = "";

            if (mode === 'sim' && res.isFuture) {
                amV = masterSchedule[d].am; pmV = masterSchedule[d].pm;
                cellClass = "status-special"; 
            } else {
                const st = attInfo.status || "";
                const inT = attInfo.inTime || "00:00:00";
                
                // [ìˆ˜ì • ë¶€ìœ„] 'ë¯¸í¸ì…'ì¸ ê²½ìš°ì—ë„ 'ê²°ì„(status-absent)' ìƒ‰ìƒì„ ì ìš©í•˜ì—¬ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                if (st.includes("ì§€ê°") || st.includes("ì¡°í‡´") || (parseInt(inT.replace(/:/g, '')) > 90000 && parseInt(inT.replace(/:/g, '')) < 130000)) {
                    cellClass = "status-late";
                } else if (st.includes("ì™¸ì¶œ")) {
                    cellClass = "status-out";
                } else if (st.includes("ê²°ì„") || st === "ë¯¸í¸ì…") { // ì´ ë¶€ë¶„ì— 'ë¯¸í¸ì…'ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
                    cellClass = "status-absent";
                } else if (st.includes("íœ´ê°€") || st.includes("ê³µê°€") || st.includes("ê¸°íƒ€")) {
                    cellClass = "status-special";
                }
            }

            rowTotalMin += (amV + pmV);
            // style ì†ì„±ì„ ë¹„ì›Œë‘ì–´ ê¸°ì¡´ cellClassì˜ ë°°ê²½ìƒ‰ë§Œ ë‚˜ì˜¤ê²Œ í•©ë‹ˆë‹¤.
            dateCells += `<td class="${cellClass}">${amV}</td><td class="${cellClass}">${pmV}</td>`;
        });

        const makeupMin = results[name].makeupMin;
        const finalTotalMin = rowTotalMin + makeupMin;
        const percent = ((finalTotalMin / masterTotal) * 100).toFixed(1);
        const statusStyle = percent < 75 ? "color:red;" : "color:green;";

        const makeupDisplay = (headId.startsWith('pHead')) ? makeupMin : 
    `<input type="number" 
        class="edit-input makeup-input makeup-${name}" 
        data-name="${name}" 
        data-sub="${selectedSub}" 
        value="${makeupMin}" 
        oninput="this.classList.add('manual-modified'); calculateRowPercent('${name}', ${masterTotal})" 
        style="width:100%;">`;

        return `<tr>
            <td class="sticky-col">${name}</td>
            ${dateCells}
            <td style="background:#fff3e0; width:55px;">${makeupDisplay}</td>
            <td id="totalMin_${name}" style="font-weight:bold;">${finalTotalMin}</td>
            <td id="totalHour_${name}" style="color:#27ae60; font-weight:bold;">${(finalTotalMin/60).toFixed(1)}h</td>
            <td id="percent_${name}" style="font-weight:bold; ${statusStyle}">${percent}%</td>
        </tr>`;
    }).join('');

    tbody.innerHTML = masterRowHtml + studentHtml;
}


// ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•œ í—¬í¼
function renderSimulation(sub, hId, bId, mode) {
    loadDetailInto(sub, hId, bId).then(() => {
        // ê¸°ì¡´ draw í•¨ìˆ˜ë¥¼ ì°¾ê¸° ìœ„í•´ ë‹¤ì‹œ í˜¸ì¶œí•˜ê±°ë‚˜ ë¡œì§ ë¶„ë¦¬ í•„ìš”
        // ê°„ë‹¨í•˜ê²Œ ìœ„í•´ loadDetailInto ë‚´ë¶€ì— mode íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ê¹”ë”í•¨
    });
}

function updateStudentTotal(name, inputEl) {
    if (inputEl) { if (inputEl.value === "") inputEl.classList.remove('manual-modified'); else inputEl.classList.add('manual-modified'); }
    const amInputs = document.querySelectorAll(`.am-input-${name}`), pmInputs = document.querySelectorAll(`.pm-input-${name}`);
    let sum = 0;
    amInputs.forEach(input => sum += (parseInt(input.value) || 0));
    pmInputs.forEach(input => sum += (parseInt(input.value) || 0));
    document.getElementById(`totalMin_${name}`).innerText = sum;
    document.getElementById(`totalHour_${name}`).innerText = (sum / 60).toFixed(1) + "h";
}

// [ìˆ˜ë¦¬ í•µì‹¬] ì—”ì§„ ë¡œì§: ì…/í‡´ì‹¤/ì™¸ì¶œ/ë³µê·€ ì‹œê°„ì„ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ ë¶„(Minute)ì„ ì‚°ì¶œí•©ë‹ˆë‹¤.
function calculateParticipation(date, inTime, outTime, targetSub, leaveTime, returnTime, modeOverride) {
    if (!inTime || !outTime || inTime.startsWith("00")) return {am:0, pm:0};
    
    // ì£¼ì°¨ë³„ ìƒì„¸ í´ë¦­ ì‹œì—” ì „ë‹¬ë°›ì€ ëª¨ë“œë¥¼, ê·¸ ì™¸ì—” í˜„ì¬ ì „ì—­ ëª¨ë“œë¥¼ ì‚¬ìš©
    const activeMode = modeOverride || currentMode;
    const scheds = rawTimetable.filter(r => {
        const rowVal = (activeMode === 'subject') ? String(r.êµê³¼ëª© || "") : String(r.ëŠ¥ë ¥ë‹¨ìœ„ || "");
        return getFixDate(r.ë‚ ì§œ) === date && rowVal.replace(/\s+/g, "") === String(targetSub).replace(/\s+/g, "");
    });

    let am = 0, pm = 0;
    const toMin = (t) => {
        if (!t || !String(t).includes(':')) return 0;
        const p = t.split(':');
        return parseInt(p[0]) * 60 + parseInt(p[1]);
    };
    const sIn = toMin(inTime), sOut = toMin(outTime), lIn = toMin(leaveTime), rIn = toMin(returnTime);
    const lunchS = 13 * 60, lunchE = 13 * 60 + 30;

    scheds.forEach(s => {
        let timeStr = String(s.ì‹œê°„ || s.êµìœ¡ì‹œê°„ || "").replace(/\s/g, "");
        let parts = timeStr.split(/[~-]/);
        if (parts.length >= 2) {
            let start = toMin(parts[0]), end = toMin(parts[1]) + 10;
            let actualStart = Math.max(sIn, start), actualEnd = Math.min(sOut, end);
            let dur = Math.max(0, actualEnd - actualStart);
            const overlapLunch = Math.max(0, Math.min(actualEnd, lunchE) - Math.max(actualStart, lunchS));
            dur -= overlapLunch;
            if (lIn > 0 && rIn > 0) {
                const overlapOut = Math.max(0, Math.min(rIn, actualEnd) - Math.max(lIn, actualStart));
                const outLunch = Math.max(0, Math.min(rIn, lunchE) - Math.max(lIn, lunchS));
                dur -= (overlapOut - outLunch);
            }
            const p = String(s.êµì‹œ).trim();
            if (['1','2','3','4'].includes(p)) am += dur;
            else if (['5','6','7','8'].includes(p)) pm += dur;
        }
    });
    return {am: Math.round(am), pm: Math.round(pm)};
}

function changeMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    const tabButtons = document.querySelectorAll('.tab-btn');
    if (mode === 'subject') tabButtons[0].classList.add('active');
    else if (mode === 'ncs') tabButtons[1].classList.add('active');
    else if (mode === 'calendar') tabButtons[2].classList.add('active');
    else if (mode === 'weekly') tabButtons[3].classList.add('active');
    const fRow = document.getElementById('subjectFilterRow'), vArea = document.getElementById('viewArea'), topAction = document.getElementById('topActionArea'), dashboardTitle = document.getElementById('dashboardTitle');
    if(mode === 'subject' || mode === 'ncs') { 
        fRow.style.display = 'table-row'; topAction.style.display = 'block'; vArea.innerHTML = ""; 
        dashboardTitle.innerText = mode === 'subject' ? "ğŸ“˜ êµê³¼ëª© ìƒì„¸ ëª©ë¡" : "ğŸ“œ ëŠ¥ë ¥ë‹¨ìœ„ ìƒì„¸ ëª©ë¡";
        updateActionSelect(); renderSubjectList('name'); 
    } else { fRow.style.display = 'none'; topAction.style.display = 'none'; vArea.innerHTML = ""; if(mode === 'calendar') renderCalendar(); else renderWeekly(); }
}

function moveMonth(offset) { calMonth += offset; if(calMonth > 11) { calYear++; calMonth = 0; } if(calMonth < 0) { calYear--; calMonth = 11; } renderCalendar(); }

let calendarSubMode = 'subject'; // ë‹¬ë ¥ ì „ìš© ë¶„ë¥˜ ëª¨ë“œ ë³€ìˆ˜ ì¶”ê°€

function renderCalendar() {
    const viewArea = document.getElementById('viewArea');
    if (rawTimetable.length === 0) { viewArea.innerHTML = "<p style='text-align:center; padding:50px;'>ë°ì´í„° ë¡œë“œ ì¤‘...</p>"; return; }
    const lastDateMap = {};
    rawTimetable.forEach(r => {
        const sub = (calendarSubMode === 'subject' ? r.êµê³¼ëª© : r.ëŠ¥ë ¥ë‹¨ìœ„) ? 
                    String(calendarSubMode === 'subject' ? r.êµê³¼ëª© : r.ëŠ¥ë ¥ë‹¨ìœ„).trim() : "";
        if (sub !== "" && isActualSubject(sub)) {
            const d = getFixDate(r.ë‚ ì§œ);
            if (!lastDateMap[sub] || d > lastDateMap[sub]) { lastDateMap[sub] = d; }
        }
    });

    let calHtml = `
        <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:20px; display:flex; align-items:center; gap:15px; justify-content: center;">
            <span style="font-weight:bold; color:#1b5e20;">ğŸ” ë‹¬ë ¥ í‘œì‹œ ê¸°ì¤€:</span>
            <button onclick="calendarSubMode='subject'; renderCalendar();" class="tab-btn ${calendarSubMode === 'subject' ? 'active' : ''}" style="border-radius:4px; padding:6px 15px;">êµê³¼ëª©ë³„</button>
            <button onclick="calendarSubMode='ncs'; renderCalendar();" class="tab-btn ${calendarSubMode === 'ncs' ? 'active' : ''}" style="border-radius:4px; padding:6px 15px;">ëŠ¥ë ¥ë‹¨ìœ„ë³„</button>
            <div style="margin-left:20px; font-size:12px; color:#666;">ğŸ’¡ <b style="color:#f39c12;">ë‚ ì§œ ìˆ«ì</b>ë¥¼ í´ë¦­í•˜ë©´ í‰ê°€ ì¼ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div class="calendar-ctrl">
            <button class="ctrl-btn" onclick="moveMonth(-1)">â—€ ì´ì „ ë‹¬</button>
            <div style='font-size:20px;'><strong>${calYear}ë…„ ${calMonth + 1}ì›”</strong></div>
            <button class="ctrl-btn" onclick="moveMonth(1)">ë‹¤ìŒ ë‹¬ â–¶</button>
        </div>
        <div class="calendar-grid">`;

    const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    days.forEach(d => calHtml += `<div style="text-align:center; font-weight:bold; background:#eee; padding:5px;">${d}</div>`);
    
    const firstDay = new Date(calYear, calMonth, 1).getDay(), lastDate = new Date(calYear, calMonth + 1, 0).getDate(), prevLastDate = new Date(calYear, calMonth, 0).getDate();
    const firstDateData = new Date(getFixDate(rawTimetable[0].ë‚ ì§œ)), lastDateData = new Date(getFixDate(rawTimetable[rawTimetable.length - 1].ë‚ ì§œ));
    const startSunday = new Date(firstDateData); startSunday.setDate(firstDateData.getDate() - firstDateData.getDay()); startSunday.setHours(0,0,0,0);
    const endSunday = new Date(lastDateData); endSunday.setDate(lastDateData.getDate() - lastDateData.getDay()); endSunday.setHours(0,0,0,0);
    
    for(let i = firstDay - 1; i >= 0; i--) { calHtml += `<div class="calendar-day" style="opacity: 0.4; background: #f9f9f9;"><div class="day-num">${prevLastDate - i}</div></div>`; }
    
    for(let d=1; d<=lastDate; d++) {
        const currentDate = new Date(calYear, calMonth, d), targetDate = `${calYear}-${String(calMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`, dayType = currentDate.getDay();
        
        // [ìˆ˜ì •] í‰ê°€ì¼ ë°°ê²½ìƒ‰ ë° ê°•ì¡° ë¡œì§
        const isEvalDay = evaluationDates[targetDate];
        const evalStyle = isEvalDay ? `background-color: #fffde7 !important; border: 2px solid #f1c40f !important;` : ``;
        const evalBadge = isEvalDay ? `<span style="font-size:10px; color:#e67e22; font-weight:bold; margin-left:5px;">ğŸ“¢ í‰ê°€ì¼</span>` : "";

        const classNames = `calendar-day ${dayType === 0 ? 'sun' : dayType === 6 ? 'sat' : ''}`;
        let weekBadge = ""; if(dayType === 0) { currentDate.setHours(0,0,0,0); if(currentDate >= startSunday && currentDate <= endSunday) { const weekNum = Math.floor((currentDate - startSunday) / (1000 * 60 * 60 * 24 * 7)) + 1; weekBadge = `<div style="font-size:10px; color:#27ae60; background:#e8f5e9; padding:2px 4px; border-radius:3px; display:inline-block; margin-left:5px;">(${weekNum}ì£¼ì°¨)</div>`; } }
        
        const subjectHours = {}; const holidays = new Set();
        rawTimetable.forEach(r => { 
            if(getFixDate(r.ë‚ ì§œ) === targetDate) { 
                const sub = (calendarSubMode === 'subject' ? r.êµê³¼ëª© : r.ëŠ¥ë ¥ë‹¨ìœ„) ? String(calendarSubMode === 'subject' ? r.êµê³¼ëª© : r.ëŠ¥ë ¥ë‹¨ìœ„).trim() : "";
                if(sub !== "" && String(r.êµì‹œ).trim() !== "ì ì‹¬") { 
                    if(isActualSubject(sub)) subjectHours[sub] = (subjectHours[sub] || 0) + 1; 
                    else holidays.add(sub); 
                } 
            } 
        });

        const attBadge = fullAttendanceData[targetDate] ? `<span style="font-size:10px; color:#27ae60; background:#e8f5e9; padding:2px 5px; border-radius:10px; border:1px solid #27ae60; margin-left:5px; vertical-align:middle;">âœ”ï¸ ì™„ë£Œ</span>` : "";
        
        let dayContent = Object.entries(subjectHours).map(([s, h]) => {
            const isLastDay = (lastDateMap[s] === targetDate);
            const lastStatus = isLastDay ? ` <span style="color:#c0392b; font-weight:bold;">[ì¢…ë£Œ]</span>` : "";
            return `<span class="subject-tag" style="cursor:pointer; font-weight:bold; border:1px solid #3498db;" 
                      onclick="openSubjectFromCalendar('${s}', '${calendarSubMode}', '${targetDate}')">
                      ğŸ” ${s} ${h}h${lastStatus}
                    </span>`;
        }).join('');
        
        dayContent += Array.from(holidays).map(h => `<span class="holiday-tag">${h}</span>`).join('');

        // [ìˆ˜ì •] ë‚ ì§œ ìˆ«ì í´ë¦­ ì‹œ í‰ê°€ì¼ í† ê¸€ í•¨ìˆ˜ í˜¸ì¶œ
        calHtml += `<div class="${classNames}" style="${evalStyle}">
            <div class="day-num" style="cursor:pointer;" onclick="toggleEvaluationDate('${targetDate}')">
                ${d}${weekBadge}${attBadge}${evalBadge}
            </div>
            ${dayContent}
        </div>`;
    }
    const nextCells = (firstDay + lastDate) % 7 === 0 ? 0 : 7 - ((firstDay + lastDate) % 7);
    for(let i = 1; i <= nextCells; i++) { calHtml += `<div class="calendar-day" style="opacity: 0.4; background: #f9f9f9;"><div class="day-num">${i}</div></div>`; }
    calHtml += `</div>`; viewArea.innerHTML = calHtml;
}

function renderWeekly() {
    const viewArea = document.getElementById('viewArea'); if (rawTimetable.length === 0) return;
    const weeklyData = {}; 
    const firstDate = new Date(getFixDate(rawTimetable[0].ë‚ ì§œ)); 
    const startSunday = new Date(firstDate); 
    startSunday.setDate(firstDate.getDate() - firstDate.getDay()); 
    startSunday.setHours(0,0,0,0);

    // [í†µê³„ìš© ë³€ìˆ˜ ì¶”ê°€]
    let totalAllWeeksTime = 0;
    const allUniqueSubjects = new Set();

    rawTimetable.forEach(row => {
        const sub = (weeklySubMode === 'subject' ? row.êµê³¼ëª© : row.ëŠ¥ë ¥ë‹¨ìœ„) ? String(weeklySubMode === 'subject' ? row.êµê³¼ëª© : row.ëŠ¥ë ¥ë‹¨ìœ„).trim() : "";
        if(String(row.êµì‹œ).trim() !== "ì ì‹¬" && sub !== "" && isActualSubject(sub)) {
            const currentDate = new Date(getFixDate(row.ë‚ ì§œ)); 
            currentDate.setHours(0,0,0,0);
            const week = Math.floor(Math.floor((currentDate - startSunday) / (1000 * 60 * 60 * 24)) / 7) + 1;
            if(!weeklyData[week]) { 
                const wStart = new Date(startSunday); wStart.setDate(startSunday.getDate() + (week - 1) * 7); 
                const wEnd = new Date(wStart); wEnd.setDate(wStart.getDate() + 6); 
                weeklyData[week] = { totalHours: 0, subjectMap: {}, period: `${wStart.getMonth()+1}.${wStart.getDate()}~${wEnd.getMonth()+1}.${wEnd.getDate()}`, dates: new Set() }; 
            }
            weeklyData[week].totalHours++; 
            weeklyData[week].subjectMap[sub] = (weeklyData[week].subjectMap[sub] || 0) + 1;
            weeklyData[week].dates.add(getFixDate(row.ë‚ ì§œ));
            
            // [í†µê³„ ë°ì´í„° ëˆ„ì ]
            totalAllWeeksTime++;
            allUniqueSubjects.add(sub);
        }
    });

    const sortedWeeks = Object.keys(weeklyData).sort((a, b) => parseInt(a) - parseInt(b));
    
    // [ìƒë‹¨ ì •ë³´ì°½ ì¶”ê°€ ë° í—¤ë” ìˆ˜ì •]
    let html = `
        <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:20px; display:flex; align-items:center; gap:15px;">
            <span style="font-weight:bold; color:#1b5e20;">ğŸ” ì£¼ì°¨ë³„ ë¶„ë¥˜ ê¸°ì¤€:</span>
            <button onclick="weeklySubMode='subject'; renderWeekly();" class="tab-btn ${weeklySubMode === 'subject' ? 'active' : ''}" style="border-radius:4px; padding:6px 15px;">êµê³¼ëª©ë³„</button>
            <button onclick="weeklySubMode='ncs'; renderWeekly();" class="tab-btn ${weeklySubMode === 'ncs' ? 'active' : ''}" style="border-radius:4px; padding:6px 15px;">ëŠ¥ë ¥ë‹¨ìœ„ë³„</button>
        </div>
        <div style="margin-bottom:15px; font-weight:bold; color:#2c3e50;">ğŸ’¡ ê³¼ëª©ëª…ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì£¼ì°¨ ë°”ë¡œ ì•„ë˜ì— ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>`;

    html += `<table class="attendance-table" style="table-layout: fixed; width: 100%; border-collapse: collapse;">
                <colgroup><col style="width: 15%;"><col style="width: 70%;"><col style="width: 15%;"></colgroup>
                <thead>
                    <tr style="background:#2c3e50; color:white;">
                        <th>ì£¼ì°¨ (ì´ ${sortedWeeks.length}ì£¼)</th>
                        <th>ì§„í–‰ ${weeklySubMode === 'subject' ? 'êµê³¼ëª©' : 'ëŠ¥ë ¥ë‹¨ìœ„'}(ì‹œê°„) (ì´ ${allUniqueSubjects.size}ê°œ)</th>
                        <th>í•©ê³„ (ì´ ${totalAllWeeksTime}h)</th>
                    </tr>
                </thead>
                <tbody>`;

    sortedWeeks.forEach(w => { 
        const d = weeklyData[w]; 
        const dateList = Array.from(d.dates).join(','); 
        const subTexts = Object.entries(d.subjectMap).sort((a, b) => a[0].localeCompare(b[0], 'ko')).map(([n, h]) => 
            `<span style="color:#3498db; cursor:pointer; text-decoration:underline; font-weight:bold; margin-right:10px; display:inline-block;" 
             onclick="showWeeklySubjectDetail('${n}', '${dateList}', '${w}')">${n}(${h}h)</span>`
        ).join(' '); 

        html += `<tr style="border-bottom: 1px solid #ddd;">
                    <td style="background:#f8f9fa;"><strong>${w}ì£¼</strong><br><small>${d.period}</small></td>
                    <td style="text-align:left; padding:12px 15px;">${subTexts}</td>
                    <td style="color:#e67e22; font-weight:bold;">${d.totalHours}h</td>
                 </tr>`;
        html += `<tr id="weeklyDetailRow_${w}" style="display:none;">
                    <td colspan="3" id="weeklyDetailArea_${w}" style="padding:15px; background-color:#f1f4f7; border: 1px solid #3498db;"></td>
                 </tr>`;
    });
    html += `</tbody></table>`;
    viewArea.innerHTML = html;
}

async function saveManualAttendance() {
    const allInputs = document.querySelectorAll('.edit-input'), manualUpdate = {}; let hasChange = false;
    
    allInputs.forEach(input => {
        if (input.classList.contains('manual-modified')) {
            const name = input.getAttribute('data-name');
            const date = input.getAttribute('data-date');
            const type = input.getAttribute('data-type');
            const sub = input.getAttribute('data-sub'); // ë³´ê°• ë°ì´í„°ìš© ê³¼ëª©ëª…

            if (!manualUpdate[name]) manualUpdate[name] = {};

            if (input.classList.contains('makeup-input')) {
                // ë³´ê°• ì‹œê°„ ì €ì¥
                manualUpdate[name][`makeup_${sub}`] = parseInt(input.value) || 0;
            } else {
                // ì¼ë°˜ ì¶œê²° ìˆ˜ì • ì €ì¥
                if (!manualUpdate[name][date]) manualUpdate[name][date] = {};
                manualUpdate[name][date][type] = parseInt(input.value);
                manualUpdate[name][date][type + "_manual"] = true;
            }
            hasChange = true;
        }
    });
    if (!hasChange) return alert("ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); if (!confirm("ë³€ê²½ì‚¬í•­ì„ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try { await database.ref(`${currentClass}/manualAttendance`).update(manualUpdate); alert("âœ… ì„œë²„ì— ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
    catch (e) { alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
}
// ì£¼ì°¨ë³„ íŠ¹ì • ê³¼ëª© í´ë¦­ ì‹œ ìƒì„¸ ë‚´ì—­ ì¶œë ¥ í•¨ìˆ˜
async function showWeeklySubjectDetail(subName, dateListStr, weekNum) {
    const targetDates = dateListStr.split(',').sort();
    
    // ëª¨ë“  ìƒì„¸ í–‰ì„ ë¨¼ì € ë‹«ê³ , í˜„ì¬ í´ë¦­í•œ ì£¼ì°¨ì˜ ìƒì„¸ í–‰ë§Œ ì—½ë‹ˆë‹¤.
    document.querySelectorAll('[id^="weeklyDetailRow_"]').forEach(el => el.style.display = 'none');
    const detailRow = document.getElementById(`weeklyDetailRow_${weekNum}`);
    const detailArea = document.getElementById(`weeklyDetailArea_${weekNum}`);
    
    detailRow.style.display = 'table-row';
    detailArea.innerHTML = `<div style="padding:15px; text-align:center;">âŒ› [${subName}] ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>`;

    const manualSnap = await database.ref(`${currentClass}/manualAttendance`).once('value');
    const manualData = manualSnap.val() || {};
    const studentResults = {}, dateWithDay = {}, weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    
    let maxWeekMin = 0;
    const weekSchedule = {};
    studentNames.forEach(name => studentResults[name] = { dates: {}, totalMin: 0 });

    const actualSubjectDates = targetDates.filter(date => {
        return rawTimetable.some(r => {
            const rowVal = (weeklySubMode === 'subject' ? r.êµê³¼ëª© : r.ëŠ¥ë ¥ë‹¨ìœ„) || "";
            return getFixDate(r.ë‚ ì§œ) === date && rowVal.replace(/\s+/g, "") === subName.replace(/\s+/g, "");
        });
    });

    actualSubjectDates.forEach(date => {
        dateWithDay[date] = date + " (" + weekDays[new Date(date).getDay()] + ")";
        const daySched = calculateParticipation(date, "09:00", "17:30", subName, "", "", weeklySubMode);
        const dayTotal = daySched.am + daySched.pm;
        weekSchedule[date] = dayTotal;
        maxWeekMin += dayTotal;

        studentNames.forEach(name => {
            const att = (fullAttendanceData[date] && fullAttendanceData[date][name]) ? fullAttendanceData[date][name] : null;
            let calc = { am: 0, pm: 0 };
            if (att && att.inTime && att.outTime) {
                calc = calculateParticipation(date, att.inTime, att.outTime, subName, att.leaveTime || "", att.returnTime || "", weeklySubMode);
            }
            if (manualData[name] && manualData[name][date]) {
                if (manualData[name][date].am !== undefined) calc.am = manualData[name][date].am;
                if (manualData[name][date].pm !== undefined) calc.pm = manualData[name][date].pm;
            }
            studentResults[name].dates[date] = calc;
            studentResults[name].totalMin += (calc.am + calc.pm);
        });
    });

    const formatMin = (m) => {
        if (m === 0) return "0ë¶„";
        const h = Math.floor(m / 60); const min = m % 60;
        return h > 0 ? `${h}ì‹œê°„ ${min}ë¶„` : `${min}ë¶„`;
    };

    let html = `<div style="background:#fff; padding:15px; border:1px solid #3498db; border-radius:4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-weight:bold; color:#2980b9; font-size:16px;">ğŸ” ${weekNum}ì£¼ì°¨ ìƒì„¸: ${subName} <span style="margin-left:15px; color:#e67e22; font-size:13px;">(ì£¼ê°„ í¸ì„±: ${formatMin(maxWeekMin)})</span></div>
            <button onclick="document.getElementById('weeklyDetailRow_${weekNum}').style.display='none'" style="padding:3px 8px; cursor:pointer; background:#95a5a6; color:white; border:none; border-radius:3px; font-size:12px;">ì°½ ë‹«ê¸° âœ–</button>
        </div>
        <div class="scroll-box" style="max-height: 850px !important;"> 
            <table class="attendance-table" style="background:white;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th rowspan="2" style="width:100px;">í›ˆë ¨ìƒëª…</th>
                        <th rowspan="2" style="background:#e8f5e9; width:120px; color:#2c3e50;">ì£¼ê°„ í•©ê³„</th>`;
    actualSubjectDates.forEach(d => html += `<th colspan="2">${dateWithDay[d]}<br><small>(${weekSchedule[d]}ë¶„)</small></th>`);
    html += `<th rowspan="2" style="background:#e8f5e9; width:80px;">ìƒíƒœ</th></tr>
                    <tr style="background:#f8f9fa;">`;
    actualSubjectDates.forEach(() => html += `<th>ì˜¤ì „</th><th>ì˜¤í›„</th>`);
    html += `</tr></thead><tbody>`;

    studentNames.forEach(name => {
        const tMin = studentResults[name].totalMin;
        const rowStyle = (tMin < maxWeekMin) ? `background-color: #fff9c4;` : ``;
        const statusText = (tMin < maxWeekMin) ? `<span style="color:#d35400; font-weight:bold;">ë¶€ì¡±</span>` : `<span style="color:#27ae60;">ì´ìˆ˜</span>`;

        html += `<tr style="${rowStyle}">
                    <td style="font-weight:bold;">${name}</td>
                    <td style="font-weight:bold; color:#2c3e50;">${formatMin(tMin)}</td>`;
        actualSubjectDates.forEach(d => {
            const res = studentResults[name].dates[d] || { am: 0, pm: 0 };
            html += `<td>${res.am}</td><td>${res.pm}</td>`;
        });
        html += `<td>${statusText}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
    
    detailArea.innerHTML = html;
    detailRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ë³´ê°• ì‹œê°„ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶œì„ë¥ ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
function calculateRowPercent(name, masterTotal) {
    // 1. í˜„ì¬ ì…ë ¥í•œ ë³´ê°• ì‹œê°„ íŒŒì•… (ì§€ìš°ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬)
    const makeupInput = document.querySelector(`.makeup-${name}`);
    const makeupValue = parseInt(makeupInput.value) || 0;

    // 2. [í•µì‹¬] ìˆœìˆ˜ ìˆ˜ì—… ì¶œì„ ì‹œê°„(ë³´ê°• ì œì™¸)ì„ ë‹¤ì‹œ ì •í™•íˆ ê³„ì‚°
    // í˜„ì¬ í–‰(tr)ì—ì„œ ë³´ê°• ì…ë ¥ì¹¸ì„ ì œì™¸í•œ ëª¨ë“  ìˆ«ì ì…€(td)ì˜ í•©ì„ êµ¬í•©ë‹ˆë‹¤.
    const row = makeupInput.closest('tr');
    const cells = row.querySelectorAll('td');
    let rowSum = 0;

    // ì„±ëª…(0ë²ˆ), í¸ì„±ì‹œê°„í–‰ ë“±ì„ ì œì™¸í•˜ê³  ì‹¤ì œ ì¶œê²° ì‹œê°„(ìˆ«ì)ì´ ì íŒ ì…€ë§Œ í•©ì‚°
    // ì˜¤ì „/ì˜¤í›„ ì¹¸ë“¤ì„ ìˆœíšŒí•˜ë©° ìˆ«ìë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    for (let i = 1; i < cells.length; i++) {
        // ë³´ê°•/ëˆ„ê³„/ì¶œì„ë¥  ì¹¸ì€ ì œì™¸ (ë’¤ì—ì„œ 4ê°œ ì¹¸: ë³´ê°•, ë¶„, ì‹œê°„, ì¶œì„ë¥ )
        if (i >= cells.length - 4) break;
        
        const val = parseInt(cells[i].innerText) || 0;
        rowSum += val;
    }

    // 3. ìµœì¢… í•©ì‚° ë° í™”ë©´ ì—…ë°ì´íŠ¸
    const finalSum = rowSum + makeupValue;
    const percent = ((finalSum / masterTotal) * 100).toFixed(1);
    
    // ëˆ„ê³„ ë¶„ ì—…ë°ì´íŠ¸
    document.getElementById(`totalMin_${name}`).innerText = finalSum;
    // ëˆ„ê³„ ì‹œê°„ ì—…ë°ì´íŠ¸
    document.getElementById(`totalHour_${name}`).innerText = (finalSum / 60).toFixed(1) + "h";
    // ì¶œì„ë¥  ë° ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    const percentEl = document.getElementById(`percent_${name}`);
    percentEl.innerText = percent + "%";
    percentEl.style.color = percent < 75 ? "red" : "green";
}
// [ìƒˆë¡œìš´ ë¡œì§] ë‹¬ë ¥ì—ì„œ ê³¼ëª© í´ë¦­ ì‹œ íŒì—…ì°½ ë„ìš°ê¸°
async function openSubjectFromCalendar(subName, mode, selectedDate) {
    const modal = document.getElementById('calendarModal');
    const modalTitle = document.getElementById('modalTitle');
    const actionArea = document.getElementById('modalActionArea');
    
    currentMode = mode; 
    // ì „ì—­ ë³€ìˆ˜ë‚˜ ì†ì„±ìœ¼ë¡œ í´ë¦­ëœ ë‚ ì§œë¥¼ ì„ì‹œ ì €ì¥í•˜ì—¬ renderFinalTableì—ì„œ ì°¸ì¡°í•˜ê²Œ í•©ë‹ˆë‹¤.
    window.lastSelectedDate = selectedDate; 

    modal.style.display = 'flex';
    modalTitle.innerText = `ğŸ“‹ [ì „ì²´ ì´ë ¥] ${subName}`;
    document.getElementById('modalHead').innerHTML = "<tr><td colspan='5'>ê³¼ëª© ì „ì²´ ë°ì´í„°ë¥¼ ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
    document.getElementById('modalBody').innerHTML = "";

    actionArea.innerHTML = `
        <div style="display: flex; gap: 10px; align-items: center; font-size: 11px; font-weight: bold; margin-right:auto;">
             <span style="color:#e67e22;">â— ê°•ì¡°ëœ ì—´: í´ë¦­í•œ ë‚ ì§œ(${selectedDate})</span>
        </div>
        <button class="btn-excel" onclick="saveManualAttendance()" style="background-color: #e67e22 !important;">ğŸ’¾ ìˆ˜ì •ì‚¬í•­ ì €ì¥</button>
    `;

    loadDetailInto(subName, 'modalHead', 'modalBody', 'real');
}

// ëª¨ë‹¬ ë°”ê¹¥ìª½ í´ë¦­ ì‹œ ë‹«ê¸°
function closeCalendarModal(e) {
    if(e.target.id === 'calendarModal') {
        document.getElementById('calendarModal').style.display = 'none';
    }
}

async function toggleEvaluationDate(date) {
    const isExists = evaluationDates[date];
    if (!isExists) {
        if (confirm(`ğŸ“… [${date}]\ní‰ê°€ ì¼ì •ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¬ë ¥ ë°°ê²½ì´ ë…¸ë€ìƒ‰ìœ¼ë¡œ ê°•ì¡°ë©ë‹ˆë‹¤.`)) {
            try {
                await database.ref(`${currentClass}/evaluationDates/${date}`).set({
                    timestamp: new Date().getTime(),
                    type: 'í‰ê°€'
                });
            } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        }
    } else {
        if (confirm(`ğŸ—‘ï¸ [${date}]\nì´ë¯¸ ë“±ë¡ëœ í‰ê°€ ì¼ì •ì…ë‹ˆë‹¤.\nì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            try {
                await database.ref(`${currentClass}/evaluationDates/${date}`).remove();
            } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
        }
    }
}

// [ì¶”ê°€] ìˆ˜ë™ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™” í•¨ìˆ˜
async function resetAllManualData() {
    // 1ë‹¨ê³„ í™•ì¸
    const firstCheck = confirm("â— ì •ë§ ëª¨ë“  ìˆ˜ë™ ì…ë ¥ ê¸°ë¡(ë³´ê°• ì‹œê°„, ìˆ˜ë™ ì¶œê²° ìˆ˜ì •, í‰ê°€ì¼ ë“±)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ì ˆëŒ€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    
    if (!firstCheck) return;

    // 2ë‹¨ê³„ í™•ì¸ (ì§ì ‘ ì…ë ¥)
    const secondCheck = prompt('ìœ„í—˜í•œ ì‘ì—…ì…ë‹ˆë‹¤. ì‚­ì œë¥¼ ì›í•˜ì‹œë©´ ì•„ë˜ì— "ì‚­ì œí•©ë‹ˆë‹¤"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    if (secondCheck === "ì‚­ì œí•©ë‹ˆë‹¤") {
        try {
            // ì‚­ì œ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸
            const updates = {};
            updates[`${currentClass}/manualAttendance`] = null; // ë³´ê°• ë° ìˆ˜ë™ ìˆ˜ì • ë°ì´í„° ì‚­ì œ
            updates[`${currentClass}/evaluationDates`] = null;  // í‰ê°€ì¼ ì¼ì • ì‚­ì œ

            await database.ref().update(updates);
            
            alert("âœ… ëª¨ë“  ìˆ˜ë™ ì…ë ¥ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
        } catch (e) {
            alert("âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    } else {
        alert('ë¬¸êµ¬ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

// [ì‹ ê·œ ê¸°ëŠ¥] ì „ì²´ ê³¼ëª© ì¼ê´„ ì¸ì‡„
async function executeAllPrint() {
    const targetList = currentMode === 'subject' ? masterSubjectList : ncsList;
    if (!targetList.length) return alert("ì¸ì‡„í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
    
    if (!confirm(`ì´ ${targetList.length}ê°œì˜ ê³¼ëª©ì„ í•œ ë²ˆì— ì¸ì‡„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) return;

    const printArea = document.getElementById('printOnlyArea');
    printArea.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
    printArea.style.display = "block"; // ë°ì´í„° ë¡œë“œ ì¤‘ ë³´ì´ì§€ ì•Šê²Œ ì²˜ë¦¬í•˜ë ¤ë©´ ìŠ¤íƒ€ì¼ ì¡°ì • í•„ìš”

    // ë¡œë”© í‘œì‹œìš© ì•Œë¦¼ (ê°„ì´)
    const loadingDiv = document.createElement('div');
    loadingDiv.innerText = "ë°ì´í„° ì§‘ê³„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
    loadingDiv.style.textAlign = "center";
    loadingDiv.style.padding = "20px";
    document.body.appendChild(loadingDiv);

    try {
        for (let i = 0; i < targetList.length; i++) {
            const subName = targetList[i];
            const pageDiv = document.createElement('div');
            pageDiv.className = "print-page-break"; // í˜ì´ì§€ ë„˜ê¹€ ì„¤ì •
            
            // ì¸ì‡„ìš© ì–‘ì‹ ìƒì„± (ê¸°ì¡´ printOnlyArea ë‚´ë¶€ êµ¬ì¡° ë³µì œ)
            pageDiv.innerHTML = `
                <div id="printSubjectTitle" style="display:block !important; text-align:center; font-size:20px; font-weight:bold; margin-bottom:8px; border-bottom:2px solid #000;">
                    ì¶œì„ë¶€: ${subName}
                </div>
                <table class="excel-info-table" style="margin-bottom:10px !important; border:1.5px solid #000 !important;">
                    <tr>
                        <td class="info-label" style="background:#f2f2f2 !important; padding:6px !important;">í›ˆë ¨ê³¼ì • :</td>
                        <td class="info-value" style="padding:6px !important; color:#000 !important;">${document.getElementById('infoCourse').innerText}</td>
                        <td class="info-label" style="background:#f2f2f2 !important; padding:6px !important;">í›ˆë ¨ê¸°ê°„ :</td>
                        <td class="info-value" style="padding:6px !important; color:#000 !important;">${document.getElementById('infoPeriod').innerText}</td>
                    </tr>
                </table>
                <div class="scroll-box">
                    <table class="attendance-table" style="width:100% !important; border:1.5px solid black !important; border-collapse:collapse !important;">
                        <thead id="pHead_${i}"></thead>
                        <tbody id="pBody_${i}"></tbody>
                    </table>
                </div>
                <div style="margin-top:10px;"></div>
            `;
            printArea.appendChild(pageDiv);

            // ì¤‘ìš”: ê²€ì¦ëœ loadDetailInto í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ì£¼ì…
            // ê° ë°˜ë³µë§ˆë‹¤ ê³ ìœ í•œ ID(pHead_0, pHead_1...)ë¥¼ ë„˜ê²¨ ì •í™•í•œ ìœ„ì¹˜ì— ê·¸ë¦¬ê²Œ í•©ë‹ˆë‹¤.
            await loadDetailInto(subName, `pHead_${i}`, `pBody_${i}`, 'real');
        }

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ì¸ì‡„ì°½ ë„ìš°ê¸°
        setTimeout(() => {
            loadingDiv.remove();
            window.print();
        }, 1000);
        
    } catch (e) {
        console.error(e);
        alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        loadingDiv.remove();
    }
}

initialize();
</script>
</body>
</html>