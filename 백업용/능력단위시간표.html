<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>종합 능력단위 출석 관리 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* [DESIGN_FIXED] 선생님 디자인 및 엑셀 시안성 유지 */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .excel-container { max-width: 100%; background: white; padding: 30px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .excel-header-title { text-align: center; font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #27ae60; color: white; border-color: #27ae60; }
        .calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); /* 7칸을 무조건 동일한 비율로 고정 */
    gap: 10px; 
    margin-top: 20px; 
    width: 100%;           /* 전체 너비를 꽉 채움 */
}
        .calendar-day { min-height: 120px; border: 1px solid #ddd; padding: 10px; background: white; position: relative; border-radius: 5px; }
        .calendar-day.sun { color: red; background: #fff5f5; }
        .calendar-day.sat { color: blue; background: #f5faff; }
        .day-num { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .subject-tag { 
    display: block; 
    font-size: 11px; 
    padding: 4px 6px; 
    background: #e3f2fd; 
    color: #1976d2; 
    border-radius: 3px; 
    margin-bottom: 4px; 
    line-height: 1.3;      /* 줄 간격을 살짝 넓혀 가독성 향상 */
    
    /* [수정] 긴 과목명을 칸에 맞춰 아래로 줄바꿈 */
    white-space: normal;      /* 줄바꿈 허용 */
    word-break: break-all;    /* 칸 끝에서 글자 단위로 강제 줄바꿈 */
    word-wrap: break-word;    /* 긴 단어도 칸 내에서 줄바꿈 */
}
        .attendance-check { position: absolute; bottom: 10px; right: 10px; font-size: 10px; font-weight: bold; color: #27ae60; background: #e8f5e9; padding: 2px 6px; border-radius: 10px; display: none; }
        .attendance-check.done { display: block; border: 1px solid #27ae60; }
        .calendar-ctrl { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; }
        .ctrl-btn { padding: 5px 15px; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .scroll-box { max-height: 700px; overflow: auto; border: 1px solid #ccc; position: relative; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        .attendance-table th, .attendance-table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 50; border-right: 2px solid #27ae60 !important; font-weight: bold; }
        .btn-nav { padding: 8px 15px; border: 1.5px solid #3498db; border-radius: 4px; cursor: pointer; text-decoration: none; color: #3498db; font-weight: bold; }
        .excel-info-table { width: 100%; border: 2px solid #27ae60; border-collapse: collapse; margin-bottom: 20px; }
        .info-label { background: #f0faf3; font-weight: bold; width: 120px; text-align: center; padding: 10px; border: 1px solid #ccc; }
        .info-value { color: #27ae60; font-weight: bold; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="excel-container">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <a href="#" class="btn-nav" onclick="location.href='index.html?class=' + currentClass">◀ 메인으로</a>
        <div style="font-weight:bold; color:#27ae60;">[ 학급: <span id="dispClass">-</span> ]</div>
    </div>
    <div class="excel-header-title">종합 능력단위 출석 관리 시스템</div>
    <div class="tab-menu">
        <div class="tab-btn active" onclick="changeMode('subject')">과목별 보기</div>
        <div class="tab-btn" onclick="changeMode('calendar')">요일별(달력) 보기</div>
        <div class="tab-btn" onclick="changeMode('weekly')">주차별 보기</div>
    </div>
    <table class="excel-info-table">
        <tr>
            <td class="info-label">훈련과정 :</td><td class="info-value" id="infoCourse">-</td>
            <td class="info-label">훈련기간 :</td><td class="info-value" id="infoPeriod">-</td>
        </tr>
        <tr id="subjectFilterRow">
            <td class="info-label">교과목 선택 :</td>
            <td class="info-value" colspan="3">
                <select id="subjectSelect" onchange="filterTimetable(this.value)" style="width:100%; padding:5px;">
                    <option value="">교과목을 선택하세요</option>
                </select>
            </td>
        </tr>
    </table>
    <div id="viewArea">
        <div class="scroll-box">
            <table class="attendance-table">
                <thead id="sheetHead"></thead>
                <tbody id="sheetBody">
                    <tr><td colspan="10" style="padding:100px; color:#999; text-align:center;">모드를 선택해 주세요.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "테스트";
document.getElementById('dispClass').innerText = currentClass;

let rawTimetable = [];
let dailyAttStatus = {}; 
let currentMode = 'subject';
let studentNames = ["강민성", "김남훈", "김민근", "박종현", "안제덕", "양신우", "엄태환", "우정민", "유경곤", "유지훈", "이의준", "이진명", "이태경", "이태권", "이호영", "전법보", "전태민", "정민규", "조윤기", "한도원"];
let calYear, calMonth;
/* [정밀 수리] index.html의 교과목 리스트 대조 방식 */
function isActualSubject(subName) {
    if (!subName || subName === "undefined" || subName === "") return false;
    
    // [보안] 만약 서버에서 아직 리스트를 못 가져왔다면, 필터링을 잠시 유보함 (달력 증발 방지)
    if (!masterSubjectList || masterSubjectList.length === 0) return true;
    
    return masterSubjectList.some(masterSub => masterSub.trim() === subName.trim());
}

/* [핵심] 선생님의 황금 로직 - 날짜 문자열 강제 변환기 */
function getFixDate(rawDate) {
    if (!rawDate) return "날짜미상";
    let s = String(rawDate).trim();
    if (s.includes('/')) {
        let parts = s.split('/');
        if (parts.length === 3) {
            let mm = parts[0].padStart(2, '0');
            let dd = parts[1].padStart(2, '0');
            let yy = parts[2];
            if (yy.length === 2) yy = "20" + yy;
            return `${yy}-${mm}-${dd}`; // YYYY-MM-DD 강제 조립
        }
    } else if (s.includes('.')) {
        return s.replace(/\./g, '-').substring(0, 10);
    } else if (s.includes('-')) {
        return s.substring(0, 10);
    }
    return s;
}

async function initialize() {
    // 훈련과정 및 교과목 리스트 로드
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('infoCourse').innerText = d.name || "-";
        document.getElementById('infoPeriod').innerText = d.period || "-";
        
        if(d.courses) {
            // [중요] 전역 변수에 교과목 리스트 박제
            masterSubjectList = [...new Set(d.courses.map(c => c.subject))];
            
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">교과목을 선택하세요</option>';
            masterSubjectList.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub; opt.innerText = sub;
                select.appendChild(opt);
            });

            // [추가] 교과목 리스트를 다 불러왔으니, 이제 달력을 다시 그립니다.
            if(currentMode === 'calendar') renderCalendar();
        }
    });

    // 시간표 데이터 로드 (기존 유지)
    database.ref(`${currentClass}/fullTimetable`).on('value', snap => {
        rawTimetable = snap.val() || [];
        if(rawTimetable.length > 0 && calYear === undefined) {
            const firstDate = getFixDate(rawTimetable[0].날짜);
            const parts = firstDate.split('-');
            calYear = parseInt(parts[0]);
            calMonth = parseInt(parts[1]) - 1;
        }
        if(currentMode === 'calendar') renderCalendar();
    });

    database.ref(`${currentClass}/attendance`).on('value', snap => {
        dailyAttStatus = snap.val() || {};
    });
}

function changeMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (event) event.target.classList.add('active');
    const filterRow = document.getElementById('subjectFilterRow');
    if(mode === 'subject') {
        filterRow.style.display = 'table-row';
        document.getElementById('viewArea').innerHTML = '<div class="scroll-box"><table class="attendance-table"><thead id="sheetHead"></thead><tbody id="sheetBody"></tbody></table></div>';
    } else if(mode === 'calendar') {
        filterRow.style.display = 'none';
        renderCalendar();
    } else if(mode === 'weekly') {
        filterRow.style.display = 'none';
        renderWeekly();
    }
}

function moveMonth(offset) {
    calMonth += offset;
    if(calMonth > 11) { calYear++; calMonth = 0; }
    if(calMonth < 0) { calYear--; calMonth = 11; }
    renderCalendar();
}

function renderCalendar() {
    const viewArea = document.getElementById('viewArea');
    let calHtml = `<div class="calendar-ctrl"><button class="ctrl-btn" onclick="moveMonth(-1)">◀ 이전 달</button><div style='font-size:20px;'><strong>${calYear}년 ${calMonth + 1}월</strong></div><button class="ctrl-btn" onclick="moveMonth(1)">다음 달 ▶</button></div>`;
    calHtml += `<div class="calendar-grid">`;
    const days = ["일", "월", "화", "수", "목", "금", "토"];
    days.forEach(d => calHtml += `<div style="text-align:center; font-weight:bold; background:#eee; padding:5px;">${d}</div>`);

    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const lastDate = new Date(calYear, calMonth + 1, 0).getDate();

    for(let i=0; i<firstDay; i++) calHtml += `<div></div>`;

    for(let d=1; d<=lastDate; d++) {
        const targetDate = `${calYear}-${String(calMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayType = new Date(calYear, calMonth, d).getDay();
        const classNames = `calendar-day ${dayType === 0 ? 'sun' : dayType === 6 ? 'sat' : ''}`;
        
        const subjectHours = {};
        rawTimetable.forEach(r => {
            if(getFixDate(r.날짜) === targetDate) { // [황금로직 적용]
                const sub = r.교과목 ? String(r.교과목).trim() : "";
                const p = r.교시 ? String(r.교시).trim() : "";
                if(sub !== "" && p !== "점심" && isActualSubject(sub)) {
                    subjectHours[sub] = (subjectHours[sub] || 0) + 1;
                }
            }
        });

        const isAttDone = dailyAttStatus[targetDate] ? "done" : "";
        calHtml += `<div class="${classNames}"><div class="day-num">${d}</div>${Object.entries(subjectHours).map(([s, h]) => `<span class="subject-tag">${s} ${h}h</span>`).join('')}<div class="attendance-check ${isAttDone}">✔️ 출석완료</div></div>`;
    }
    calHtml += `</div>`;
    viewArea.innerHTML = calHtml;
}

function renderWeekly() {
    const viewArea = document.getElementById('viewArea');
    const weeklyData = {};
    
    rawTimetable.forEach(row => {
    const week = row.일수 ? Math.ceil(row.일수 / 5) : "기타";
    if(!weeklyData[week]) weeklyData[week] = { am: 0, pm: 0, subjects: new Set() };
    
    // 1. sub 변수를 먼저 정의해야 합니다.
    const sub = row.교과목 ? String(row.교과목).trim() : "";
    const period = String(row.교시).trim();
    
    // 2. 이제 sub를 사용할 수 있습니다.
    if(!isActualSubject(sub) || period === "점심" || isNaN(period)) return;

    if(['1','2','3','4'].includes(period)) weeklyData[week].am += 60;
    else if(['5','6','7','8'].includes(period)) weeklyData[week].pm += 60;
    if(sub) weeklyData[week].subjects.add(sub); // row.교과목 대신 정의한 sub 사용
});

    let tableHtml = `<table class="attendance-table"><thead><tr><th>주차</th><th>관련 교과목</th><th>오전(분)</th><th>오후(분)</th><th>주간 합계</th></tr></thead><tbody>`;
    Object.keys(weeklyData).forEach(w => {
        const d = weeklyData[w];
        tableHtml += `<tr><td>${w}주차</td><td style="text-align:left;">${Array.from(d.subjects).join(', ')}</td><td>${d.am}</td><td>${d.pm}</td><td>${(d.am+d.pm)/60}h</td></tr>`;
    });
    tableHtml += `</tbody></table>`;
    viewArea.innerHTML = tableHtml;
}

function filterTimetable(selectedSub) {
    if(!selectedSub) return;
    const info = {};
    const filtered = rawTimetable.filter(r => r.교과목 === selectedSub);
    
    filtered.forEach(row => {
        const d = getFixDate(row.날짜); // [황금로직 적용]
        if(!info[d]) info[d] = { am: 0, pm: 0 };
        const p = String(row.교시).trim();
        if(['1','2','3','4'].includes(p)) info[d].am += 60;
        else if(['5','6','7','8'].includes(p)) info[d].pm += 60;
    });

    const dates = Object.keys(info).sort();
    renderExcelSheet(dates, info);
}

function renderExcelSheet(dates, info) {
    const thead = document.getElementById('sheetHead');
    const tbody = document.getElementById('sheetBody');
    let h1 = `<tr><th rowspan="2" class="sticky-col">훈련생명</th>`;
    let h2 = `<tr>`;
    dates.forEach(d => {
        h1 += `<th colspan="2" style="background:#f8f9fa;">${d}</th>`;
        h2 += `<th>오전</th><th>오후</th>`;
    });
    h1 += `<th colspan="2" class="total-section">누계</th></tr>`; h2 += `<th>분</th><th>시간</th></tr>`;
    thead.innerHTML = h1 + h2;

    tbody.innerHTML = studentNames.map(name => {
        let row = `<td class="sticky-col">${name}</td>`;
        let total = 0;
        dates.forEach(d => {
            row += `<td>${info[d].am || ""}</td><td>${info[d].pm || ""}</td>`;
            total += (info[d].am + info[d].pm);
        });
        row += `<td>${total}</td><td style="font-weight:bold; color:#27ae60;">${(total/60).toFixed(1)}h</td>`;
        return `<tr>${row}</tr>`;
    }).join('');
}

initialize();
</script>
</body>
</html>