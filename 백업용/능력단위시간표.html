<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¢…í•© ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* [DESIGN_FIXED] ì„ ìƒë‹˜ ë””ìì¸ ë° ì—‘ì…€ ì‹œì•ˆì„± ìœ ì§€ */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .excel-container { 
    max-width: 1400px;    /* 1. í”„ë ˆì„ì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì œí•œ (ë„ˆë¬´ í¼ì§€ì§€ ì•Šê²Œ) */
    margin: 20px auto;    /* 2. ìƒí•˜ 20px ì—¬ë°±ì„ ì£¼ê³  ì¢Œìš°ëŠ” ìë™ìœ¼ë¡œ ë§ì¶° ì¤‘ì•™ ì •ë ¬ */
    background: white; 
    padding: 40px;        /* 3. ìƒì ë‚´ë¶€ ì—¬ë°±ì„ ëŠ˜ë ¤ ë‚´ìš©ë¬¼ì´ ì‹œì›í•˜ê²Œ ë³´ì´ê²Œ í•¨ */
    border-radius: 12px;  /* 4. ëª¨ì„œë¦¬ë¥¼ ì¡°ê¸ˆ ë” ë‘¥ê¸€ê²Œ ê¹ìŒ */
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* 5. ê·¸ë¦¼ìë¥¼ ë” ê¹Šê²Œ ì£¼ì–´ ì…ì²´ê° ë¶€ì—¬ */
}
        .excel-header-title { text-align: center; font-size: 24px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px 5px 0 0; font-weight: bold; }
        .tab-btn.active { background: #27ae60; color: white; border-color: #27ae60; }
        .calendar-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); /* 7ì¹¸ì„ ë¬´ì¡°ê±´ ë™ì¼í•œ ë¹„ìœ¨ë¡œ ê³ ì • */
    gap: 10px; 
    margin-top: 20px; 
    width: 100%;           /* ì „ì²´ ë„ˆë¹„ë¥¼ ê½‰ ì±„ì›€ */
}
        .calendar-day { min-height: 120px; border: 1px solid #ddd; padding: 10px; background: white; position: relative; border-radius: 5px; }
        .calendar-day.sun { color: red; background: #fff5f5; }
        .calendar-day.sat { color: blue; background: #f5faff; }
        .day-num { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .subject-tag { 
    display: block; 
    font-size: 11px; 
    padding: 4px 6px; 
    background: #e3f2fd; 
    color: #1976d2; 
    border-radius: 3px; 
    margin-bottom: 4px; 
    line-height: 1.3;      /* ì¤„ ê°„ê²©ì„ ì‚´ì§ ë„“í˜€ ê°€ë…ì„± í–¥ìƒ */
    
    /* [ìˆ˜ì •] ê¸´ ê³¼ëª©ëª…ì„ ì¹¸ì— ë§ì¶° ì•„ë˜ë¡œ ì¤„ë°”ê¿ˆ */
    white-space: normal;      /* ì¤„ë°”ê¿ˆ í—ˆìš© */
    word-break: break-all;    /* ì¹¸ ëì—ì„œ ê¸€ì ë‹¨ìœ„ë¡œ ê°•ì œ ì¤„ë°”ê¿ˆ */
    word-wrap: break-word;    /* ê¸´ ë‹¨ì–´ë„ ì¹¸ ë‚´ì—ì„œ ì¤„ë°”ê¿ˆ */
}
.holiday-tag { 
    display: block; 
    font-size: 11px; 
    padding: 4px 6px; 
    background: #fff5f5; /* ì—°í•œ ë¶„í™ ë°°ê²½ */
    color: #e74c3c;      /* ê°•ë ¬í•œ ê²½ê³ ë“± ë¹¨ê°„ìƒ‰ */
    border-radius: 3px; 
    margin-bottom: 4px; 
    border: 1px dashed #feb2b2; /* ì ì„  í…Œë‘ë¦¬ë¡œ êµ¬ë¶„ */
    line-height: 1.3;
    white-space: normal;
    word-break: break-all;
}
        .attendance-check { position: absolute; bottom: 10px; right: 10px; font-size: 10px; font-weight: bold; color: #27ae60; background: #e8f5e9; padding: 2px 6px; border-radius: 10px; display: none; }
        .attendance-check.done { display: block; border: 1px solid #27ae60; }
        .calendar-ctrl { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px; }
        .ctrl-btn { padding: 5px 15px; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .scroll-box { max-height: 700px; overflow: auto; border: 1px solid #ccc; position: relative; }
        .attendance-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        .attendance-table th, .attendance-table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: #f9f9f9 !important; z-index: 50; border-right: 2px solid #27ae60 !important; font-weight: bold; }
        .btn-nav { padding: 8px 15px; border: 1.5px solid #3498db; border-radius: 4px; cursor: pointer; text-decoration: none; color: #3498db; font-weight: bold; }
        .excel-info-table { width: 100%; border: 2px solid #27ae60; border-collapse: collapse; margin-bottom: 20px; }
        .info-label { background: #f0faf3; font-weight: bold; width: 120px; text-align: center; padding: 10px; border: 1px solid #ccc; }
        .info-value { color: #27ae60; font-weight: bold; padding: 10px; border: 1px solid #ccc; }
        /* [PRINT_ENGINE] ì¸ì‡„í•  ë•Œë§Œ ì‘ë™í•˜ëŠ” ìŠ¤íƒ€ì¼ */
/* [PRINT_ENGINE] ì¸ì‡„ ì‹œ ìƒë‹¨ ì •ë³´(ê³¼ì •, ê¸°ê°„, ê³¼ëª©) ëª¨ë‘ í‘œì‹œ ë²„ì „ */
@media print {
    @page { size: A4 landscape; margin: 8mm; }
    body { background: white; padding: 0; margin: 0; }

    /* 1. ì¸ì‡„ ì‹œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ë° ì¤‘ë³µ í•„í„° í–‰ ì œê±° */
    .btn-nav, .tab-menu, .calendar-ctrl, .ctrl-btn, #printBtnArea, .excel-header-title, #subjectFilterRow { 
        display: none !important; 
    }

    /* 2. ìƒë‹¨ ì •ë³´ì™€ ì¸ì‡„ìš© ì œëª©ì€ í™•ì‹¤í•˜ê²Œ í‘œì‹œ */
    #printSubjectTitle { display: block !important; }
    .excel-info-table { display: table !important; width: 100% !important; margin-bottom: 10px !important; }

    /* 3. ëª…ë‹¨ì´ ë°€ë¦¬ì§€ ì•Šê²Œ í‘œ ê°„ê²© ìµœì†Œí™” */
    .excel-container { box-shadow: none; margin: 0; padding: 0; width: 100% !important; }
    .scroll-box { max-height: none !important; overflow: visible !important; }
    .attendance-table { width: 100% !important; table-layout: fixed !important; }
    .attendance-table th, .attendance-table td { 
        font-size: 8pt !important; 
        padding: 1px 2px !important; 
        border: 1px solid black !important; 
    }
    .sticky-col { position: static !important; background: white !important; }
}

    </style>
</head>
<body>

<div class="excel-container">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <a href="#" class="btn-nav" onclick="location.href='index.html?class=' + currentClass">â—€ ë©”ì¸ìœ¼ë¡œ</a>
        <div style="font-weight:bold; color:#27ae60;">[ í•™ê¸‰: <span id="dispClass">-</span> ]</div>
    </div>
    
<div id="printSubjectTitle" style="display: none; text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px;">
    êµê³¼ëª© ì¶œì„ë¶€: <span id="targetSubjectName">-</span>
</div>
    <div class="excel-header-title">ì¢…í•© ëŠ¥ë ¥ë‹¨ìœ„ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
    <div class="tab-menu">
        <div class="tab-btn active" onclick="changeMode('subject')">ê³¼ëª©ë³„ ë³´ê¸°</div>
        <div class="tab-btn" onclick="changeMode('calendar')">ìš”ì¼ë³„(ë‹¬ë ¥) ë³´ê¸°</div>
        <div class="tab-btn" onclick="changeMode('weekly')">ì£¼ì°¨ë³„ ë³´ê¸°</div>
    </div>
    <div id="printBtnArea" style="text-align: right; margin-bottom: 10px;">
    <button class="ctrl-btn" onclick="window.print()" style="background: #34495e;">ğŸ“„ í˜„ì¬ êµê³¼ëª© ì¸ì‡„ (A4 ê°€ë¡œ)</button>
</div>
    <table class="excel-info-table">
        <tr>
            <td class="info-label">í›ˆë ¨ê³¼ì • :</td><td class="info-value" id="infoCourse">-</td>
            <td class="info-label">í›ˆë ¨ê¸°ê°„ :</td><td class="info-value" id="infoPeriod">-</td>
        </tr>
        <tr id="subjectFilterRow">
    <td class="info-label">êµê³¼ëª© ì„ íƒ :</td>
    <td class="info-value" colspan="3">
        <select id="subjectSelect" onchange="filterTimetable(this.value)" style="width:100%; padding:5px;">
            <option value="">êµê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>
        
        <span id="targetSubjectName" class="print-only-text" style="display: none; font-weight: bold; color: black; font-size: 11pt;">-</span>
    </td>
</tr>
    </table>
    <div id="viewArea">
        <div class="scroll-box">
            <table class="attendance-table">
                <thead id="sheetHead"></thead>
                <tbody id="sheetBody">
                    <tr><td colspan="10" style="padding:100px; color:#999; text-align:center;">ëª¨ë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCO37zrsZEjKTokMCNWbIc1C_o5BZMqh8E",
    authDomain: "busan-teacher-work.firebaseapp.com",
    databaseURL: "https://busan-teacher-work-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "busan-teacher-work",
    storageBucket: "busan-teacher-work.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
let currentClass = urlParams.get('class') || "í…ŒìŠ¤íŠ¸";
document.getElementById('dispClass').innerText = currentClass;

let rawTimetable = [];
let dailyAttStatus = {}; 
let currentMode = 'subject';
let studentNames = []; // [ìˆ˜ì •] ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘, DBì—ì„œ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜´
let fullAttendanceData = {}; // [ì‹ ê·œ] ì¼ì¼ì¶œì„ë¶€ ì „ì²´ ë°ì´í„°ë¥¼ ë‹´ì„ ê·¸ë¦‡
let calYear, calMonth;
/* [ì •ë°€ ìˆ˜ë¦¬] êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ ëŒ€ì¡° ë°©ì‹ ê°•í™” */
function isActualSubject(subName) {
    if (!subName || subName === "") return false;
    const cleanSubName = String(subName).replace(/\s+/g, ""); // ëª¨ë“  ê³µë°± ì œê±°
    
    // ë“±ë¡ëœ ê³¼ëª© ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ true
    return masterSubjectList.some(masterSub => {
        const cleanMaster = String(masterSub).replace(/\s+/g, "");
        return cleanSubName.includes(cleanMaster) || cleanMaster.includes(cleanSubName);
    });
}

/* [í•µì‹¬] ì„ ìƒë‹˜ì˜ í™©ê¸ˆ ë¡œì§ - ë‚ ì§œ ë¬¸ìì—´ ê°•ì œ ë³€í™˜ê¸° */
function getFixDate(rawDate) {
    if (!rawDate) return "ë‚ ì§œë¯¸ìƒ";
    let s = String(rawDate).trim();
    if (s.includes('/')) {
        let parts = s.split('/');
        if (parts.length === 3) {
            let mm = parts[0].padStart(2, '0');
            let dd = parts[1].padStart(2, '0');
            let yy = parts[2];
            if (yy.length === 2) yy = "20" + yy;
            return `${yy}-${mm}-${dd}`; // YYYY-MM-DD ê°•ì œ ì¡°ë¦½
        }
    } else if (s.includes('.')) {
        return s.replace(/\./g, '-').substring(0, 10);
    } else if (s.includes('-')) {
        return s.substring(0, 10);
    }
    return s;
}

async function initialize() {
    // í›ˆë ¨ê³¼ì • ë° êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    database.ref(`${currentClass}/masterData`).once('value', snap => {
        const d = snap.val() || {};
        document.getElementById('infoCourse').innerText = d.name || "-";
        document.getElementById('infoPeriod').innerText = d.period || "-";
        
        if(d.courses) {
            // [ì¤‘ìš”] ì „ì—­ ë³€ìˆ˜ì— êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ ë°•ì œ
            masterSubjectList = [...new Set(d.courses.map(c => c.subject))];
            
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">êµê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            masterSubjectList.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub; opt.innerText = sub;
                select.appendChild(opt);
            });

            // [ì¶”ê°€] êµê³¼ëª© ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ ë¶ˆëŸ¬ì™”ìœ¼ë‹ˆ, ì´ì œ ë‹¬ë ¥ì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            if(currentMode === 'calendar') renderCalendar();
            if(currentMode === 'weekly') renderWeekly();
        }
    });

    // ì‹œê°„í‘œ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ìœ ì§€)
    database.ref(`${currentClass}/fullTimetable`).on('value', snap => {
        rawTimetable = snap.val() || [];
        if(rawTimetable.length > 0 && calYear === undefined) {
            const firstDate = getFixDate(rawTimetable[0].ë‚ ì§œ);
            const parts = firstDate.split('-');
            calYear = parseInt(parts[0]);
            calMonth = parseInt(parts[1]) - 1;
        }
        if(currentMode === 'calendar') renderCalendar();
        if(currentMode === 'weekly') renderWeekly();
    });

    database.ref(`${currentClass}/dailyAttendance`).on('value', snap => {
        fullAttendanceData = snap.val() || {};
        const allDates = Object.keys(fullAttendanceData).sort().reverse();
        if (allDates.length > 0) {
            // ê°€ì¥ ìµœê·¼ ì¶œì„ë¶€ì—ì„œ í•™ìƒ ëª…ë‹¨ì„ ë½‘ì•„ì˜µë‹ˆë‹¤.
            studentNames = Object.keys(fullAttendanceData[allDates[0]]).sort();
        }
        // ëª…ë‹¨ì´ í™•ë³´ë˜ì—ˆìœ¼ë‹ˆ í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í™”ë©´ ê°±ì‹ 
        if(currentMode === 'subject' && document.getElementById('subjectSelect').value) {
            filterTimetable(document.getElementById('subjectSelect').value);
        }
    });
}

function changeMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (event) event.target.classList.add('active');
    const filterRow = document.getElementById('subjectFilterRow');
    if(mode === 'subject') {
        filterRow.style.display = 'table-row';
        document.getElementById('viewArea').innerHTML = '<div class="scroll-box"><table class="attendance-table"><thead id="sheetHead"></thead><tbody id="sheetBody"></tbody></table></div>';
    } else if(mode === 'calendar') {
        filterRow.style.display = 'none';
        renderCalendar();
    } else if(mode === 'weekly') {
        filterRow.style.display = 'none';
        renderWeekly();
    }
}

function moveMonth(offset) {
    calMonth += offset;
    if(calMonth > 11) { calYear++; calMonth = 0; }
    if(calMonth < 0) { calYear--; calMonth = 11; }
    renderCalendar();
}

function renderCalendar() {
    const viewArea = document.getElementById('viewArea');
    let calHtml = `<div class="calendar-ctrl"><button class="ctrl-btn" onclick="moveMonth(-1)">â—€ ì´ì „ ë‹¬</button><div style='font-size:20px;'><strong>${calYear}ë…„ ${calMonth + 1}ì›”</strong></div><button class="ctrl-btn" onclick="moveMonth(1)">ë‹¤ìŒ ë‹¬ â–¶</button></div>`;
    calHtml += `<div class="calendar-grid">`;
    const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
    days.forEach(d => calHtml += `<div style="text-align:center; font-weight:bold; background:#eee; padding:5px;">${d}</div>`);

    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const lastDate = new Date(calYear, calMonth + 1, 0).getDate();
    
    // [ì¶”ê°€] ì´ì „ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ì •ë³´
    const prevLastDate = new Date(calYear, calMonth, 0).getDate();

    if (rawTimetable.length === 0) return;
    const firstDateData = new Date(getFixDate(rawTimetable[0].ë‚ ì§œ));
    const lastDateData = new Date(getFixDate(rawTimetable[rawTimetable.length - 1].ë‚ ì§œ));
    
    const startSunday = new Date(firstDateData);
    startSunday.setDate(firstDateData.getDate() - firstDateData.getDay());
    startSunday.setHours(0,0,0,0);

    const endSunday = new Date(lastDateData);
    endSunday.setDate(lastDateData.getDate() - lastDateData.getDay());
    endSunday.setHours(0,0,0,0);

    // 1. [ìˆ˜ì •] ì´ì „ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸° (ì—°í•˜ê²Œ í‘œì‹œ)
    for(let i = firstDay - 1; i >= 0; i--) {
        const prevDay = prevLastDate - i;
        calHtml += `<div class="calendar-day" style="opacity: 0.4; background: #f9f9f9;"><div class="day-num">${prevDay}</div></div>`;
    }

    // 2. í˜„ì¬ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    for(let d=1; d<=lastDate; d++) {
        const currentDate = new Date(calYear, calMonth, d);
        const targetDate = `${calYear}-${String(calMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayType = currentDate.getDay();
        const classNames = `calendar-day ${dayType === 0 ? 'sun' : dayType === 6 ? 'sat' : ''}`;
        
        let weekBadge = "";
        if(dayType === 0) {
            currentDate.setHours(0,0,0,0);
            if(currentDate >= startSunday && currentDate <= endSunday) {
                const diffTime = currentDate - startSunday;
                const weekNum = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7)) + 1;
                const isLast = currentDate.getTime() === endSunday.getTime() ? " - ë§ˆì§€ë§‰" : "";
                weekBadge = `<div style="font-size:10px; color:#27ae60; background:#e8f5e9; padding:2px 4px; border-radius:3px; display:inline-block; margin-left:5px;">(${weekNum}ì£¼ì°¨${isLast})</div>`;
            }
        }

        const subjectHours = {};
        const holidays = new Set();

        rawTimetable.forEach(r => {
            if(getFixDate(r.ë‚ ì§œ) === targetDate) {
                const sub = r.êµê³¼ëª© ? String(r.êµê³¼ëª©).trim() : "";
                const p = r.êµì‹œ ? String(r.êµì‹œ).trim() : "";
                if(sub !== "" && p !== "ì ì‹¬") {
                    if(isActualSubject(sub)) {
                        subjectHours[sub] = (subjectHours[sub] || 0) + 1;
                    } else {
                        holidays.add(sub);
                    }
                }
            }
        });

        const isAttDone = dailyAttStatus[targetDate] ? "done" : "";
        let dayContent = Object.entries(subjectHours).map(([s, h]) => `<span class="subject-tag">${s} ${h}h</span>`).join('');
        dayContent += Array.from(holidays).map(hText => `<span class="holiday-tag">${hText}</span>`).join('');

        calHtml += `<div class="${classNames}"><div class="day-num">${d}${weekBadge}</div>${dayContent}<div class="attendance-check ${isAttDone}">âœ”ï¸ ì¶œì„ì™„ë£Œ</div></div>`;
    }

    // 3. [ì¶”ê°€] ë‹¤ìŒ ë‹¬ ë‚ ì§œ ì±„ìš°ê¸° (ì—°í•˜ê²Œ í‘œì‹œ, 7ì—´ ê½‰ ì±„ìš°ê¸°)
    const totalCells = firstDay + lastDate;
    const nextCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for(let i = 1; i <= nextCells; i++) {
        calHtml += `<div class="calendar-day" style="opacity: 0.4; background: #f9f9f9;"><div class="day-num">${i}</div></div>`;
    }

    calHtml += `</div>`;
    viewArea.innerHTML = calHtml;
}

function renderWeekly() {
    const viewArea = document.getElementById('viewArea');
    if (!masterSubjectList || masterSubjectList.length === 0) {
        viewArea.innerHTML = "<p style='text-align:center; padding:50px;'>êµê³¼ëª© ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";
        return;
    }
    const weeklyData = {};
    if (rawTimetable.length === 0) return;

    const firstDateStr = getFixDate(rawTimetable[0].ë‚ ì§œ);
    const firstDate = new Date(firstDateStr);
    const startSunday = new Date(firstDate);
    startSunday.setDate(firstDate.getDate() - firstDate.getDay());
    startSunday.setHours(0,0,0,0);

    let grandTotalHours = 0;
    let totalSubjectsSet = new Set();

    rawTimetable.forEach(row => {
        const sub = row.êµê³¼ëª© ? String(row.êµê³¼ëª©).trim() : "";
        const period = row.êµì‹œ ? String(row.êµì‹œ).trim() : "";
        const rowDateStr = getFixDate(row.ë‚ ì§œ);
        
        if(period !== "ì ì‹¬" && sub !== "" && isActualSubject(sub)) {
            const currentDate = new Date(rowDateStr);
            currentDate.setHours(0,0,0,0);
            const diffTime = currentDate - startSunday;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const week = Math.floor(diffDays / 7) + 1;
            
            if(!weeklyData[week]) {
                const weekStart = new Date(startSunday);
                weekStart.setDate(startSunday.getDate() + (week - 1) * 7);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                const periodRange = `${weekStart.getMonth() + 1}.${weekStart.getDate()}~${weekEnd.getMonth() + 1}.${weekEnd.getDate()}`;
                weeklyData[week] = { totalHours: 0, subjectMap: {}, period: periodRange };
            }
            weeklyData[week].totalHours += 1;
            weeklyData[week].subjectMap[sub] = (weeklyData[week].subjectMap[sub] || 0) + 1;
            grandTotalHours += 1;
            totalSubjectsSet.add(sub);
        }
    });

    const sortedWeeks = Object.keys(weeklyData).sort((a, b) => parseInt(a) - parseInt(b));

    // [ìˆ˜ë¦¬ í•µì‹¬] <colgroup>ì„ ì‚¬ìš©í•˜ì—¬ í‘œì˜ ê¸°í‹€ì„ 5%/90%/5%ì— ê°€ê¹ê²Œ ê°•ì œ ê³ ì •í•©ë‹ˆë‹¤.
    let tableHtml = `<table class="attendance-table" style="text-align: center; table-layout: fixed; width: 100%; min-width: 800px;">
        <colgroup>
            <col style="width: 7%;">  <col style="width: 86%;"> <col style="width: 7%;">  </colgroup>
        <thead style="position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <tr style="background-color: #2c3e50; color: #ffffff; font-weight: bold;">
                <td style="padding:10px 2px; border-bottom: 2px solid #34495e; font-size: 11px;">ì´ ${sortedWeeks.length}ì£¼</td>
                <td style="padding:10px 2px; border-bottom: 2px solid #34495e;">ì „ì²´ ì§„í–‰ êµê³¼ëª©: ${totalSubjectsSet.size}ì¢…</td>
                <td style="padding:10px 2px; font-size:12px; border-bottom: 2px solid #34495e;">ì´ ${grandTotalHours}h</td>
            </tr>
            <tr style="background-color: #f8f9fa; color: #333;">
                <th style="padding: 5px 2px; font-size: 11px;">ì£¼ì°¨</th>
                <th>ì§„í–‰ëœ êµê³¼ëª©(ì‹œê°„)</th>
                <th style="padding: 5px 2px; font-size: 11px;">í•©ê³„</th>
            </tr>
        </thead>
        <tbody>`;
    
    sortedWeeks.forEach(w => {
        const d = weeklyData[w];
        if(d.totalHours > 0) {
            const subjectTexts = Object.entries(d.subjectMap).map(([name, hour]) => `${name}(${hour}h)`).join(', ');
            tableHtml += `<tr>
                <td style="background:#f8f9fa; border-left:4px solid #27ae60; padding:10px 2px; text-align: center;">
                    <span style="font-weight:bold; font-size:13px;">${w}ì£¼</span><br>
                    <span style="font-size:8px; color:#666; font-weight:normal;">(${d.period})</span>
                </td>
                <td style="padding:10px 15px; white-space:normal; line-height:1.6; text-align: center; word-break: keep-all;">
                    ${subjectTexts}
                </td>
                <td style="font-weight:bold; color:#e67e22; font-size:14px; background:#fff9f0; text-align: center; padding: 10px 2px;">
                    ${d.totalHours}h
                </td>
            </tr>`;
        }
    });
    
    if(sortedWeeks.length === 0) tableHtml += `<tr><td colspan="3" style="padding:100px; color:#999;">ì§„í–‰ëœ ìˆ˜ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    tableHtml += `</tbody></table>`;
    viewArea.innerHTML = tableHtml;
}
/* [ì„ ìƒë‹˜ ì „ìš© í™©ê¸ˆ ì—”ì§„] ì…í‡´ì‹¤ ì‹œê°„ ëŒ€ì¡° ë¶„ ë‹¨ìœ„ ê³„ì‚°ê¸° */
function calculateParticipation(date, inTime, outTime, targetSubject) {
    if (!inTime || !outTime) return { am: 0, pm: 0 };

    const daySchedules = rawTimetable.filter(r => {
        return getFixDate(r.ë‚ ì§œ) === date && String(r.êµê³¼ëª©).trim() === targetSubject;
    });

    if (daySchedules.length === 0) return { am: 0, pm: 0 };

    let amMinutes = 0;
    let pmMinutes = 0;

    const toMinSafe = (t) => {
        if(!t) return 0;
        const parts = String(t).trim().replace(/[^0-9:]/g, "").split(':');
        if(parts.length < 2) return 0;
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    };

    const sIn = toMinSafe(inTime);
    const sOut = toMinSafe(outTime);

    daySchedules.forEach(sched => {
        const rawRange = String(sched.êµìœ¡ì‹œê°„ || "");
        let timeParts = rawRange.split(/[~-]/); 
        
        if (timeParts.length >= 2) {
            let start = toMinSafe(timeParts[0]);
            let end = toMinSafe(timeParts[1]);

            // [ìˆ˜ë¦¬ í¬ì¸íŠ¸] ì¢…ë£Œ ì‹œê°„ì— 10ë¶„ì˜ ì‰¬ëŠ” ì‹œê°„ì„ ë”í•´ 60ë¶„ìœ¼ë¡œ ë§ì¶¤
            // ë‹¨, 4êµì‹œ(ì˜¤ì „ ë)ë‚˜ 8êµì‹œ(ì¢…ë£Œ) ë“±ì— ë”°ë¼ ì¡°ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜ 
            // ì„ ìƒë‹˜ì˜ ìš”ì²­ëŒ€ë¡œ 'êµì‹œë‹¹ 60ë¶„'ì„ ë§ì¶”ê¸° ìœ„í•´ ì¼ê´„ 10ë¶„ ì¶”ê°€í•©ë‹ˆë‹¤.
            end = end + 10; 

            const overlapStart = Math.max(sIn, start);
            const overlapEnd = Math.min(sOut, end);
            const duration = Math.max(0, overlapEnd - overlapStart);

            const period = String(sched.êµì‹œ || "").trim();
            if (['1','2','3','4'].includes(period)) amMinutes += duration;
            else if (['5','6','7','8'].includes(period)) pmMinutes += duration;
        }
    });

    return { am: amMinutes, pm: pmMinutes };
}

function filterTimetable(selectedSub) {
    if(!selectedSub || studentNames.length === 0) return;
    document.getElementById('targetSubjectName').innerText = selectedSub;
    // 2. [ì‹ ê·œ ìˆ˜ë¦¬] ë¸Œë¼ìš°ì € íƒ€ì´í‹€ì„ ë³€ê²½í•˜ì—¬ PDF ì €ì¥ ì‹œ íŒŒì¼ëª…ìœ¼ë¡œ ì‚¬ìš©ë˜ê²Œ í•¨
    document.title = "ëŠ¥ë ¥ë‹¨ìœ„ì¶œì„ë¶€(" + selectedSub + ")";
    // [ë‚ ì§œ ì •ë ¬ ë° ìš”ì¼ ì¶”ê°€ ë¡œì§]
    const filteredDays = [...new Set(rawTimetable.filter(r => r.êµê³¼ëª© === selectedSub).map(r => getFixDate(r.ë‚ ì§œ)))].sort();
    
    const studentResults = {};
    const masterSchedule = {}; 
    const masterPeriods = {}; 
    const dateWithDay = {}; // [ì‹ ê·œ] ìš”ì¼ í¬í•¨ ë‚ ì§œ ì €ì¥

    const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    studentNames.forEach(name => {
        studentResults[name] = { dates: {}, totalMin: 0 };
    });

    filteredDays.forEach(date => {
        // ë‚ ì§œì— ìš”ì¼ ë¶™ì´ê¸° (ì˜ˆ: 2025-08-05 (í™”))
        const d = new Date(date);
        const dayName = weekDays[d.getDay()];
        dateWithDay[date] = `${date} (${dayName})`;

        masterSchedule[date] = calculateParticipation(date, "00:00", "23:59", selectedSub);

        const dayScheds = rawTimetable.filter(r => getFixDate(r.ë‚ ì§œ) === date && String(r.êµê³¼ëª©).trim() === selectedSub);
        const amP = dayScheds.map(r => r.êµì‹œ).filter(p => ['1','2','3','4'].includes(String(p)));
        const pmP = dayScheds.map(r => r.êµì‹œ).filter(p => ['5','6','7','8'].includes(String(p)));
        
        const getRange = (arr) => {
            if (arr.length === 0) return "";
            const nums = arr.map(Number).sort((a, b) => a - b);
            return nums[0] === nums[nums.length-1] ? `${nums[0]}êµì‹œ` : `${nums[0]}~${nums[nums.length-1]}êµì‹œ`;
        };
        
        masterPeriods[date] = { am: getRange(amP), pm: getRange(pmP) };

        studentNames.forEach(name => {
            const att = (fullAttendanceData[date] && fullAttendanceData[date][name]) ? fullAttendanceData[date][name] : null;
            if (att) {
                const calc = calculateParticipation(date, att.inTime, att.outTime, selectedSub);
                studentResults[name].dates[date] = calc;
                studentResults[name].totalMin += (calc.am + calc.pm);
            } else {
                studentResults[name].dates[date] = { am: 0, pm: 0 };
            }
        });
    });

    renderExcelSheet(filteredDays, studentResults, masterSchedule, masterPeriods, dateWithDay);
}

function renderExcelSheet(dates, results, masterSchedule, masterPeriods, dateWithDay) {
    const thead = document.getElementById('sheetHead');
    const tbody = document.getElementById('sheetBody');
    const viewAreaTable = document.querySelector('#viewArea table');
    
    viewAreaTable.style.tableLayout = 'fixed';
    viewAreaTable.style.width = 'auto'; 
    viewAreaTable.style.minWidth = '100%'; 

    // [ì¸ì‡„ ê³ ë ¤ ë„ˆë¹„] í›ˆë ¨ìƒëª… 80px, ì˜¤ì „/ì˜¤í›„ ê° 80pxë¡œ ë„‰ë„‰í•˜ê²Œ ì„¤ì •
    let colGroupHtml = `<colgroup><col style="width: 80px;">`; 
    dates.forEach(() => {
        colGroupHtml += `<col style="width: 80px;"><col style="width: 80px;">`;
    });
    colGroupHtml += `<col style="width: 70px;"><col style="width: 70px;"></colgroup>`;
    
    let h1 = `<tr><th rowspan="2" class="sticky-col" style="width: 80px; background: #eee; font-size: 10px;">í›ˆë ¨ìƒëª…</th>`;
    let h2 = `<tr>`;
    dates.forEach(d => {
        h1 += `<th colspan="2" style="background:#f8f9fa; font-size:10px; white-space: nowrap;">${dateWithDay[d]}</th>`;
        h2 += `<th style="font-size:9px; width:80px;">ì˜¤ì „</th><th style="font-size:9px; width:80px;">ì˜¤í›„</th>`;
    });
    h1 += `<th colspan="2" class="total-section" style="background:#e3f2fd;">ëˆ„ê³„</th></tr>`; 
    h2 += `<th style="background:#fff9f0; font-size:9px;">ë¶„</th><th style="background:#fff9f0; font-size:9px;">ì‹œê°„</th></tr>`;
    
    thead.innerHTML = colGroupHtml + h1 + h2;

    const cellStyle = `style="white-space: normal; word-break: break-all; font-size: 10px; line-height: 1.2; padding: 6px 2px;"`;

    // 1. í¸ì„± ì‹œê°„ í–‰ (ì£¼í™©ìƒ‰)
    let masterRow = `<tr style="background-color: #fff9f0; font-weight: bold; color: #e67e22;">
                        <td class="sticky-col" style="background-color: #fff9f0 !important; width: 80px; font-size: 9px;">[êµê³¼ í¸ì„± ì‹œê°„]</td>`;
    let masterTotalMin = 0;
    dates.forEach(d => {
        const am = masterSchedule[d].am;
        const pm = masterSchedule[d].pm;
        masterRow += `<td ${cellStyle}>${am}</td><td ${cellStyle}>${pm}</td>`;
        masterTotalMin += (am + pm);
    });
    masterRow += `<td style="background-color: #fff9f0; font-size: 10px;">${masterTotalMin}</td><td style="background-color: #fff9f0; font-size: 10px;">${(masterTotalMin/60).toFixed(1)}h</td></tr>`;

    // 2. í¸ì„± êµì‹œ í–‰ (ì—°ë…¹ìƒ‰)
    let periodRow = `<tr style="background-color: #f0fdf4; font-weight: bold; color: #166534;">
                        <td class="sticky-col" style="background-color: #f0fdf4 !important; width: 80px; font-size: 9px;">[êµê³¼ í¸ì„± êµì‹œ]</td>`;
    dates.forEach(d => {
        periodRow += `<td style="font-size: 9px; padding: 4px 2px;">${masterPeriods[d].am}</td>
                      <td style="font-size: 9px; padding: 4px 2px;">${masterPeriods[d].pm}</td>`;
    });
    periodRow += `<td colspan="2" style="background-color: #f0fdf4; font-size: 9px;">í¸ì„±êµì‹œ ìš”ì•½</td></tr>`;

    // 3. í•™ìƒ ë°ì´í„° í–‰
    let studentRows = studentNames.map(name => {
        let row = `<td class="sticky-col" style="width: 80px; text-align: center; font-size: 10px; background:#f9f9f9 !important;">${name}</td>`;
        let total = results[name].totalMin;
        dates.forEach(d => {
            const am = results[name].dates[d].am;
            const pm = results[name].dates[d].pm;
            row += `<td style="font-size: 10px; ${am === 0 ? 'color:#ccc' : ''}">${am || ""}</td>
                    <td style="font-size: 10px; ${pm === 0 ? 'color:#ccc' : ''}">${pm || ""}</td>`;
        });
        row += `<td style="font-weight:bold; background:#f0f7ff; font-size: 10px;">${total}</td>
                <td style="font-weight:bold; color:#27ae60; background:#f0f7ff; font-size: 10px;">${(total/60).toFixed(1)}h</td>`;
        return `<tr>${row}</tr>`;
    }).join('');

    tbody.innerHTML = masterRow + periodRow + studentRows;
}

initialize();
</script>
</body>
</html>